<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„è³‡ç”¢è¡¨ (V21 è¶¨å‹¢æˆ°æƒ…)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- é¢¨æ ¼è¨­å®š --- */
        :root {
            --bg-color: #F7F7F7;
            --card-bg: #FFFFFF;
            --text-main: #4A4A4A;
            --text-sub: #9B9B9B;
            --accent-color: #7D8668;   /* æŠ¹èŒ¶ç¶  */
            --danger-color: #B85C5C;   /* è±†æ²™ç´… */
            --link-blue: #4A90E2;
            --btn-gray: #E0E0E0;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 120px; }
        .page { display: none; padding: 20px; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .header { text-align: center; font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; padding-top: 10px; color: var(--text-main); }
        .card { background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 20px; }

        /* ---------------- V21 æ–°å¢åœ–è¡¨æ§åˆ¶å€ ---------------- */
        .chart-controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; justify-content: center; }
        .chart-toggle {
            padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; cursor: pointer;
            border: 1px solid transparent; background: var(--btn-gray); color: #666; transition: 0.2s; user-select: none;
        }
        /* å„ç¨®ç·šæ¢çš„é¡è‰²å®šç¾© (Active ç‹€æ…‹) */
        .chart-toggle.active[data-type="net"] { background: #7D8668; color: white; } /* æ·¨è³‡ç”¢-ç¶  */
        .chart-toggle.active[data-type="debt"] { background: #B85C5C; color: white; } /* è² å‚µ-ç´… */
        .chart-toggle.active[data-type="cash"] { background: #4A90E2; color: white; } /* ç¾é‡‘-è— */
        .chart-toggle.active[data-type="invest"] { background: #F5A623; color: white; } /* æŠ•è³‡-æ©˜ */
        .chart-toggle.active[data-type="card"] { background: #9013FE; color: white; } /* ä¿¡ç”¨å¡-ç´« */
        .chart-toggle.active[data-type="house"] { background: #50E3C2; color: #333; } /* æˆ¿è²¸-é’ */

        .chart-box { position: relative; height: 300px; width: 100%; }
        /* ---------------------------------------------------- */

        .date-picker-container { background: #FFF; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--accent-color); }
        .date-input { border: none; background: transparent; font-size: 1rem; color: var(--text-main); font-family: inherit; font-weight: bold; cursor: pointer; }
        
        .big-number { font-size: 2.2rem; font-weight: 700; margin: 10px 0; text-align: center; }
        .sub-number { font-size: 0.9rem; text-align: center; margin-bottom: 10px; font-weight: bold; }
        .section-title { font-size: 1rem; font-weight: bold; margin-bottom: 15px; color: var(--text-main); border-left: 4px solid var(--accent-color); padding-left: 10px; }

        .toggle-container { display: flex; justify-content: center; align-items: center; margin-bottom: 10px; font-size: 0.9rem; color: var(--text-sub); }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin: 0 10px;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #CCC; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        .card-category .detail-list { display: none; margin-top: 10px; border-top: 1px dashed #EEE; padding-top: 10px; }
        .card-category.show-details .detail-list { display: block !important; }
        .detail-item { display: flex; justify-content: space-between; font-size: 0.85rem; color: #888; margin-bottom: 6px; padding-left: 10px; }

        .dynamic-row { display: flex; align-items: center; margin-bottom: 8px; }
        .dynamic-name { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px 0 0 8px; background: #FAFAFA; font-size: 0.95rem; }
        .dynamic-val { width: 110px; padding: 10px; border: 1px solid var(--border-color); border-radius: 0 8px 8px 0; text-align: right; font-size: 1rem; }
        
        .stock-row { background-color: var(--calc-bg); border-radius: 10px; padding: 10px; margin-bottom: 12px; border: 1px solid #E0E6E0; }
        .stock-name-row { display: flex; align-items: center; margin-bottom: 5px; }
        .stock-name-input { width: 100%; border: none; background: transparent; font-weight: bold; font-size: 0.95rem; color: var(--text-main); border-bottom: 1px dashed #CCC; padding-bottom: 3px; }
        .btn-search { background: var(--link-blue); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 0.75rem; margin-right: 8px; cursor: pointer; }
        .stock-calc-row { display: flex; justify-content: space-between; align-items: center; gap: 5px; }
        .calc-group { display: flex; flex-direction: column; width: 30%; }
        .calc-input { width: 100%; padding: 5px; border: 1px solid #DDD; border-radius: 6px; text-align: center; }
        .stock-total-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(0,0,0,0.05); }

        .btn-del { margin-left: 8px; color: #CCC; font-size: 1.2rem; cursor: pointer; padding: 5px; }
        .btn-add { width: 100%; padding: 10px; border: 1px dashed #CCC; color: #888; background: transparent; border-radius: 8px; cursor: pointer; margin-top: 5px; font-size: 0.9rem; }
        .btn-save { display: block; width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .memo-input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: #FFF; margin-bottom: 15px; min-height: 80px; resize: vertical; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; color: var(--text-main); }
        .analysis-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #EEE; }
        .analysis-label { font-size: 0.95rem; font-weight: 500; color: #555; }
        .analysis-val { font-weight: bold; font-size: 1rem; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: #FFF; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #EEE; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: #C0C0C0; cursor: pointer; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .nav-item.active { color: var(--accent-color); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }

        .backup-section { text-align: center; margin-top: 30px; border-top: 1px solid #EEE; padding-top: 20px; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .btn-action { padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; border: none; color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin: 5px;}
        .btn-excel { background-color: #217346; }
        .btn-backup { background-color: #607D8B; }
        .btn-import { background-color: #FFF; border: 1px solid #607D8B; color: #607D8B; }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <div class="header">è³‡ç”¢æˆ°æƒ…å®¤</div>
        <div class="date-picker-container" style="background-color: var(--info-bg); border: none;">
            <span style="font-size: 0.9rem; color: #556B55;">ğŸ“… æœˆä»½ï¼š</span>
            <input type="month" id="home-date-picker" class="date-input" onchange="loadHomeDataByDate(this.value)">
        </div>
        
        <div class="card">
            <div style="font-size:0.9rem; color:var(--text-sub); text-align:center;">æ·¨è³‡ç”¢ç¸½é¡</div>
            <div class="big-number" id="dash-net-worth">...</div>
            <div class="sub-number" id="dash-diff"></div>
        </div>

        <div class="card">
            <h3 class="section-title">ğŸ“Š è¼ƒä¸Šæœˆè®Šå‹•åˆ†æ</h3>
            <div id="analysis-container"></div>
        </div>

        <div class="card">
            <div class="toggle-container">
                <span onclick="setMode(false)" style="cursor:pointer;">éš±è—ç´°é …</span>
                <label class="switch"><input type="checkbox" id="detailToggle" onchange="toggleDetails()"><span class="slider"></span></label>
                <span onclick="setMode(true)" style="cursor:pointer;">é¡¯ç¤ºå…¨è²Œ</span>
            </div>
        </div>
        <div id="cards-container"></div>

        <div class="backup-section">
            <button class="btn-action btn-excel" onclick="exportHistoryExcel()">åŒ¯å‡ºå®Œæ•´æ­·å² Excel</button>
            <div>
                <button class="btn-action btn-backup" onclick="exportData()">å‚™ä»½æª”æ¡ˆ</button>
                <button class="btn-action btn-import" onclick="document.getElementById('importFile').click()">åŒ¯å…¥æª”æ¡ˆ</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
        </div>
        <div style="height: 30px;"></div>
    </div>

    <div id="page-input" class="page">
        <div class="header">è³‡ç”¢ç›¤é»</div>
        <div class="date-picker-container">
            <span style="font-size: 0.9rem; color: var(--accent-color);">ğŸ“… è¨˜å¸³æœˆä»½ï¼š</span>
            <input type="month" id="input-date-picker" class="date-input" onchange="loadInputDataByDate(this.value)">
        </div>
        <div style="margin-bottom: 20px;"><textarea id="input-memo" class="memo-input" placeholder="æœ¬æœˆé‡è¦ç­†è¨˜..."></textarea></div>
        <div id="section-assets"><div id="input-sections-assets"></div></div>
        <button class="btn-save" onclick="saveData()">å„²å­˜ç´€éŒ„</button>
        <div style="height:30px"></div>
    </div>

    <div id="page-trend" class="page">
        <div class="header">è²¡å‹™è¶¨å‹¢åˆ†æ</div>
        
        <div class="card">
            <div class="section-title">ğŸ“ˆ æ­·å²è¶¨å‹¢æ¯”è¼ƒ (å¯å¤šé¸)</div>
            <div class="chart-controls">
                <div class="chart-toggle active" data-type="net" onclick="toggleDataset('net', this)">æ·¨è³‡ç”¢</div>
                <div class="chart-toggle" data-type="debt" onclick="toggleDataset('debt', this)">è² å‚µç¸½é¡</div>
                <div class="chart-toggle" data-type="cash" onclick="toggleDataset('cash', this)">ç¾é‡‘</div>
                <div class="chart-toggle" data-type="invest" onclick="toggleDataset('invest', this)">æŠ•è³‡</div>
                <div class="chart-toggle" data-type="card" onclick="toggleDataset('card', this)">ä¿¡ç”¨å¡è²»</div>
                <div class="chart-toggle" data-type="house" onclick="toggleDataset('house', this)">æˆ¿è²¸</div>
            </div>
            <div class="chart-box">
                <canvas id="multiLineChart"></canvas>
            </div>
            <div style="font-size:0.8rem; color:#999; text-align:center; margin-top:10px;">ğŸ’¡ é»æ“Šä¸Šæ–¹æŒ‰éˆ•å¯åŒæ™‚é¡¯ç¤ºå¤šæ¢æ›²ç·š</div>
        </div>

        <div class="card">
            <div class="section-title">ğŸ”¥ é€€ä¼‘è¨ˆç•« (å¤§ç›¤ ETF)</div>
            <div style="font-size:0.85rem; color:#666; margin-bottom:10px;">è¿½è¹¤æ¨™çš„ï¼šVOO, QQQ, SPY, 0050, å¤§ç›¤</div>
            <div class="chart-box" style="height:220px;">
                <canvas id="retirementChartJs"></canvas>
            </div>
        </div>
        
        <div style="height:50px"></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('home')"><span class="nav-icon">â˜–</span><span>é¦–é </span></div>
        <div class="nav-item" onclick="switchPage('input')"><span class="nav-icon">âœ</span><span>è¨˜å¸³</span></div>
        <div class="nav-item" onclick="switchPage('trend')"><span class="nav-icon">ğŸ“Š</span><span>åˆ†æ</span></div>
    </div>

    <script>
        // --- V21 æ ¸å¿ƒè®Šæ•¸ ---
        let dataStore = {}; 
        let myChart = null; // å…¨èƒ½åœ–è¡¨å¯¦ä¾‹
        let retireChart = null; // é€€ä¼‘åœ–è¡¨å¯¦ä¾‹
        let userGoal = 0; 

        // é è¨­è³‡æ–™
        const defaultTemplate = {
            cash: [{name: "åœ‹æ³°ä¸–è¯", val: 0}, {name: "å°æ–° Richart", val: 0}, {name: "ç¾é‡‘éŒ¢åŒ…", val: 0}],
            invest: [{name: "VOO (ç¾è‚¡å¤§ç›¤)", val: 0, price:0, shares:0, exrate:32.5}, {name: "0050 (å°è‚¡å¤§ç›¤)", val: 0, price:0, shares:0, exrate:1}],
            prop: [{name: "è‡ªç”¨ä½å®…", val: 0}],
            debt: [{name: "ä¿¡ç”¨å¡è²»", val: 0}, {name: "æˆ¿å±‹è²¸æ¬¾", val: 0}],
            memo: ""
        };

        let currentEditingDate = "";
        let currentEditingData = null;

        window.onload = function() {
            let stored = localStorage.getItem('myAssetData_v9_db');
            if (stored) dataStore = JSON.parse(stored);
            else migrateOrInitData();

            let today = new Date().toISOString().substring(0, 7);
            let targetDate = today;
            let dates = Object.keys(dataStore).sort();
            if (dates.length > 0) targetDate = dates[dates.length - 1];

            document.getElementById('home-date-picker').value = targetDate;
            document.getElementById('input-date-picker').value = targetDate;
            
            loadHomeDataByDate(targetDate);
            loadInputDataByDate(targetDate);
            // å»¶é²ä¸€é»åˆå§‹åŒ–åœ–è¡¨ï¼Œç¢ºä¿ DOM æº–å‚™å¥½
            setTimeout(() => {
                initHistoryChart();
                initRetireChart();
            }, 100);
        };

        // --- æ ¸å¿ƒè³‡æ–™è™•ç† ---
        function getTodayStr() { return new Date().toISOString().substring(0, 7); }
        function migrateOrInitData() {
            // å»ºç«‹å‡è³‡æ–™ä¾›æ¸¬è©¦
            dataStore["2025-11"] = JSON.parse(JSON.stringify(defaultTemplate));
            dataStore["2025-11"].debt[0].val = 20000;
            dataStore["2025-11"].cash[0].val = 100000;
            
            dataStore["2025-12"] = JSON.parse(JSON.stringify(defaultTemplate));
            dataStore["2025-12"].debt[0].val = 50000; // å‡è£å¡è²»è®Šå¤š
            dataStore["2025-12"].cash[0].val = 150000;

            dataStore["2026-01"] = JSON.parse(JSON.stringify(defaultTemplate)); 
            dataStore["2026-01"].debt[0].val = 10000; // å¡è²»é‚„äº†
            dataStore["2026-01"].cash[0].val = 80000; // ç¾é‡‘è®Šå°‘

            localStorage.setItem('myAssetData_v9_db', JSON.stringify(dataStore));
        }

        // --- V21: å…¨èƒ½åœ–è¡¨é‚è¼¯ (Chart.js) ---
        function initHistoryChart() {
            const ctx = document.getElementById('multiLineChart').getContext('2d');
            
            // æº–å‚™æ•¸æ“š
            let dates = Object.keys(dataStore).sort();
            // ç‚ºäº†ä¸è®“åœ–è¡¨å¤ªæ“ ï¼Œæœ€å¤šé¡¯ç¤ºæœ€è¿‘ 12 å€‹æœˆï¼Œå¦‚æœæƒ³çœ‹å…¨éƒ¨å¯ä»¥æ‹¿æ‰ slice
            // let displayDates = dates.slice(-12); 
            let displayDates = dates; 

            // é å…ˆè¨ˆç®—å„é¡åˆ¥æ•¸æ“šé™£åˆ—
            let dataNet = [], dataDebt = [], dataCash = [], dataInvest = [], dataCard = [], dataHouse = [];

            displayDates.forEach(d => {
                let data = dataStore[d];
                dataNet.push((getSum(data.cash)+getSum(data.invest)+getSum(data.prop)) - getSum(data.debt));
                dataDebt.push(getSum(data.debt));
                dataCash.push(getSum(data.cash));
                dataInvest.push(getSum(data.invest));
                // ç‰¹æ®Šç¯©é¸
                dataCard.push(data.debt.filter(i => i.name.includes("ä¿¡ç”¨å¡") || i.name.includes("å¡è²»")).reduce((a,b)=>a+b.val,0));
                dataHouse.push(data.debt.filter(i => i.name.includes("æˆ¿è²¸") || i.name.includes("ä¿¡è²¸")).reduce((a,b)=>a+b.val,0));
            });

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: displayDates.map(d => d.substring(5) + "æœˆ"), // åªé¡¯ç¤ºæœˆä»½
                    datasets: [
                        { label: 'æ·¨è³‡ç”¢', data: dataNet, borderColor: '#7D8668', backgroundColor: '#7D8668', hidden: false, tension: 0.3 },
                        { label: 'è² å‚µç¸½é¡', data: dataDebt, borderColor: '#B85C5C', backgroundColor: '#B85C5C', hidden: true, tension: 0.3 },
                        { label: 'ç¾é‡‘', data: dataCash, borderColor: '#4A90E2', backgroundColor: '#4A90E2', hidden: true, tension: 0.3 },
                        { label: 'æŠ•è³‡', data: dataInvest, borderColor: '#F5A623', backgroundColor: '#F5A623', hidden: true, tension: 0.3 },
                        { label: 'ä¿¡ç”¨å¡è²»', data: dataCard, borderColor: '#9013FE', backgroundColor: '#9013FE', hidden: true, tension: 0.3 },
                        { label: 'æˆ¿è²¸', data: dataHouse, borderColor: '#50E3C2', backgroundColor: '#50E3C2', hidden: true, tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, // æˆ‘å€‘è‡ªå·±åšäº†æŒ‰éˆ•ï¼Œéš±è—é è¨­åœ–ä¾‹
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: false } // è®“æ³¢å‹•çœ‹èµ·ä¾†æ˜é¡¯ä¸€é»
                    }
                }
            });
        }

        function toggleDataset(type, btn) {
            // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
            btn.classList.toggle('active');
            
            // å°æ‡‰ dataset index
            const map = { 'net':0, 'debt':1, 'cash':2, 'invest':3, 'card':4, 'house':5 };
            const idx = map[type];
            
            // åˆ‡æ›åœ–è¡¨é¡¯ç¤º
            if (myChart) {
                let isHidden = myChart.getDatasetMeta(idx).hidden;
                // Chart.js çš„ hidden é‚è¼¯: null/false = é¡¯ç¤º, true = éš±è—
                // åˆå§‹ç‹€æ…‹æˆ‘å€‘è¨­ hidden: true (é™¤äº†æ·¨è³‡ç”¢)
                // å¦‚æœç›®å‰æ˜¯ null æˆ– false (é¡¯ç¤ºä¸­)ï¼Œå°±è¦æ”¹æˆ true (éš±è—)
                // ä½†é€™è£¡æˆ‘å€‘ç”¨ classList 'active' ä¾†åˆ¤æ–·ä½¿ç”¨è€…çš„æ„åœ–
                
                if (btn.classList.contains('active')) {
                    myChart.show(idx);
                } else {
                    myChart.hide(idx);
                }
            }
        }

        // --- V21: é€€ä¼‘è¨ˆç•«åœ– (Bar Chart) ---
        function initRetireChart() {
            const ctx = document.getElementById('retirementChartJs').getContext('2d');
            let dates = Object.keys(dataStore).sort();
            let displayDates = dates.slice(-6); // åªçœ‹æœ€è¿‘6å€‹æœˆ
            
            let dataRetire = displayDates.map(d => {
                let invest = dataStore[d].invest;
                let keywords = ["VOO", "QQQ", "SPY", "0050", "å¤§ç›¤"];
                return invest.filter(item => keywords.some(k => item.name.toUpperCase().includes(k))).reduce((a, b) => a + b.val, 0);
            });

            retireChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: displayDates.map(d => d.substring(5) + "æœˆ"),
                    datasets: [{
                        label: 'å¤§ç›¤ ETF ç´¯ç©',
                        data: dataRetire,
                        backgroundColor: '#7D8668',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // --- å…¶ä»–åŠŸèƒ½ (æ²¿ç”¨) ---
        function saveData() {
            currentEditingData.memo = document.getElementById('input-memo').value;
            dataStore[currentEditingDate] = currentEditingData;
            localStorage.setItem('myAssetData_v9_db', JSON.stringify(dataStore));
            alert(`å·²å„²å­˜ï¼`);
            loadHomeDataByDate(currentEditingDate);
            
            // å„²å­˜å¾Œé‡ç•«åœ–è¡¨
            myChart.destroy();
            retireChart.destroy();
            initHistoryChart();
            initRetireChart();
            
            switchPage('home');
        }

        function loadInputDataByDate(date) {
            currentEditingDate = date;
            if (dataStore[date]) currentEditingData = JSON.parse(JSON.stringify(dataStore[date]));
            else {
                let dates = Object.keys(dataStore).sort();
                if(dates.length > 0) currentEditingData = JSON.parse(JSON.stringify(dataStore[dates[dates.length-1]]));
                else currentEditingData = JSON.parse(JSON.stringify(defaultTemplate));
            }
            if(currentEditingData.invest) {
                currentEditingData.invest.forEach(i => {
                    if(i.price===undefined) i.price=0; if(i.shares===undefined) i.shares=0; if(i.exrate===undefined) i.exrate=1;
                });
            }
            document.getElementById('input-memo').value = currentEditingData.memo || "";
            renderAssetsInput();
        }

        function renderAssetsInput() {
            const container = document.getElementById('input-sections-assets'); container.innerHTML = '';
            ['cash', 'invest', 'prop', 'debt'].forEach(type => {
                let title = type==='cash'?'ğŸ’° ç¾é‡‘':(type==='invest'?'ğŸ“ˆ æŠ•è³‡':(type==='prop'?'ğŸ  ä¸å‹•ç”¢':'ğŸ’¸ è² å‚µ'));
                let html = `<div class="card"><div class="section-header">${title} <span id="total-${type}-edit" style="font-size:0.9rem; color:#888;">$0</span></div><div id="list-${type}">`;
                if(type === 'invest') {
                    currentEditingData[type].forEach((item, index) => html += buildStockRowHtml(index, item));
                } else {
                    currentEditingData[type].forEach((item, index) => html += buildRowHtml(type, index, item));
                }
                html += `</div><button class="btn-add" onclick="addRow('${type}')">+ æ–°å¢é …ç›®</button></div>`;
                container.innerHTML += html;
            });
            updateEditTotals();
        }

        function buildRowHtml(type, index, item) {
            return `<div class="dynamic-row"><input type="text" class="dynamic-name" value="${item.name}" onchange="updateSimpleData('${type}', ${index}, 'name', this.value)"><input type="number" class="dynamic-val" value="${item.val}" placeholder="0" onchange="updateSimpleData('${type}', ${index}, 'val', this.value)"><div class="btn-del" onclick="delRow('${type}', ${index})">Ã—</div></div>`;
        }
        function buildStockRowHtml(index, item) {
            return `<div class="stock-row"><div class="stock-name-row"><input type="text" class="stock-name-input" value="${item.name}" onchange="updateStockData(${index}, 'name', this.value)"><button class="btn-search" onclick="searchStockPrice(${index})">ğŸ” æŸ¥åƒ¹</button><div class="btn-del" onclick="delRow('invest', ${index})">Ã—</div></div><div class="stock-calc-row"><div class="calc-group"><label class="calc-label">è‚¡åƒ¹</label><input type="number" class="calc-input" value="${item.price||''}" placeholder="0" onchange="updateStockData(${index}, 'price', this.value)"></div><div style="color:#CCC;">Ã—</div><div class="calc-group"><label class="calc-label">è‚¡æ•¸</label><input type="number" class="calc-input" value="${item.shares||''}" placeholder="0" onchange="updateStockData(${index}, 'shares', this.value)"></div><div style="color:#CCC;">Ã—</div><div class="calc-group"><label class="calc-label">åŒ¯ç‡</label><input type="number" class="calc-input" value="${item.exrate||1}" placeholder="1" onchange="updateStockData(${index}, 'exrate', this.value)"></div></div><div class="stock-total-row"><span style="font-size:0.8rem;color:var(--accent-color);font-weight:bold;">= å¸‚å€¼</span><span style="font-weight:bold;">$${item.val.toLocaleString()}</span></div></div>`;
        }
        function searchStockPrice(index) {
            let item = currentEditingData.invest[index];
            let stockName = item.name.replace(/\(.*\)/, '');
            window.open(`https://www.google.com/search?q=${encodeURIComponent(`${stockName} stock price ${currentEditingDate}`)}`, '_blank');
        }
        function updateSimpleData(type, index, key, val) { if(key === 'val') val = Number(val) || 0; currentEditingData[type][index][key] = val; updateEditTotals(); }
        function updateStockData(index, key, val) { let item = currentEditingData.invest[index]; if(key === 'name') item.name = val; else { item[key] = Number(val) || 0; item.val = Math.round(item.price * item.shares * item.exrate); } renderAssetsInput(); }
        function addRow(type) { if(type === 'invest') currentEditingData[type].push({name: "", val: 0, price: 0, shares: 0, exrate: 1}); else currentEditingData[type].push({name: "", val: 0}); renderAssetsInput(); }
        function delRow(type, index) { if(confirm("åˆªé™¤ï¼Ÿ")) { currentEditingData[type].splice(index, 1); renderAssetsInput(); } }
        function updateEditTotals() { ['cash', 'invest', 'prop', 'debt'].forEach(type => { let sum = currentEditingData[type].reduce((a, b) => a + b.val, 0); document.getElementById('total-' + type + '-edit').innerText = '$' + sum.toLocaleString(); }); }
        function getSum(arr) { return arr ? arr.reduce((a, b) => a + b.val, 0) : 0; }
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            if(page==='home') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(page==='input') document.querySelectorAll('.nav-item')[1].classList.add('active');
            if(page==='trend') document.querySelectorAll('.nav-item')[2].classList.add('active');
        }
        function loadHomeDataByDate(date) {
            let data = dataStore[date];
            if (!data) {
                document.getElementById('dash-net-worth').innerText = "ç„¡è³‡æ–™";
                document.getElementById('dash-diff').innerText = "è«‹é¸æ“‡å…¶ä»–æœˆä»½";
                document.getElementById('analysis-container').innerHTML = "<div style='text-align:center;color:#999;padding:10px;'>ğŸ“­ æœ¬æœˆå°šæœªè¨˜å¸³</div>";
                document.getElementById('cards-container').innerHTML = "";
                return;
            }
            let netWorth = (getSum(data.cash) + getSum(data.invest) + getSum(data.prop)) - getSum(data.debt);
            document.getElementById('dash-net-worth').innerText = 'NT$ ' + netWorth.toLocaleString();
            let dates = Object.keys(dataStore).sort();
            let currIdx = dates.indexOf(date);
            let diff = 0;
            if (currIdx > 0) {
                let prevD = dataStore[dates[currIdx - 1]];
                let prevNet = (getSum(prevD.cash) + getSum(prevD.invest) + getSum(prevD.prop)) - getSum(prevD.debt);
                diff = netWorth - prevNet;
                let sign = diff >= 0 ? 'â–²' : 'â–¼';
                let color = diff >= 0 ? 'var(--accent-color)' : 'var(--danger-color)';
                document.getElementById('dash-diff').innerText = `${sign} è¼ƒä¸Šæœˆ ${diff >= 0 ? '+' : ''}${diff.toLocaleString()}`;
                document.getElementById('dash-diff').style.color = color;
            } else { document.getElementById('dash-diff').innerText = "åˆå§‹ç´€éŒ„"; }

            // è‡ªå‹•åˆ†æ HTML ç”Ÿæˆ
            let diffCash = 0, diffInvest = 0, diffDebt = 0;
            if (currIdx > 0) {
                let prevData = dataStore[dates[currIdx - 1]];
                diffCash = getSum(data.cash) - getSum(prevData.cash);
                diffInvest = getSum(data.invest) - getSum(prevData.invest);
                diffDebt = getSum(data.debt) - getSum(prevData.debt);
            }
            document.getElementById('analysis-container').innerHTML = `
                <div class="analysis-row"><span class="analysis-label">ğŸ’° ç¾é‡‘è®Šå‹•</span><span class="analysis-val" style="color:${diffCash>=0?'var(--accent-color)':'var(--danger-color)'}">${diffCash>=0?'+':''}${diffCash.toLocaleString()}</span></div>
                <div class="analysis-row"><span class="analysis-label">ğŸ“ˆ æŠ•è³‡æç›Š</span><span class="analysis-val" style="color:${diffInvest>=0?'var(--accent-color)':'var(--danger-color)'}">${diffInvest>=0?'+':''}${diffInvest.toLocaleString()}</span></div>
                <div class="analysis-row"><span class="analysis-label">ğŸ’¸ è² å‚µè®Šå‹•</span><span class="analysis-val" style="color:${diffDebt>0?'var(--danger-color)':'var(--accent-color)'}">${diffDebt>=0?'+':''}${diffDebt.toLocaleString()}</span></div>
            `;

            const container = document.getElementById('cards-container');
            container.innerHTML = `
                ${createCard('ğŸ’° ç¾é‡‘è³‡ç”¢', getSum(data.cash), data.cash, false)}
                ${createCard('ğŸ“ˆ æŠ•è³‡éƒ¨ä½', getSum(data.invest), data.invest, false)}
                ${createCard('ğŸ  ä¸å‹•ç”¢', getSum(data.prop), data.prop, false)}
                ${createCard('ğŸ’¸ è² å‚µç¸½é¡', getSum(data.debt), data.debt, true)}
            `;
            toggleDetails();
        }
        function createCard(title, total, items, isRed) {
            let color = isRed ? 'color:var(--danger-color);' : '';
            let list = items.map(i => `<div class="detail-item"><span>${i.name||'--'}</span><span>$${i.val.toLocaleString()}</span></div>`).join('');
            return `<div class="card card-category"><div style="display:flex; justify-content:space-between; font-weight:bold;"><span>${title}</span><span style="${color}">$${total.toLocaleString()}</span></div><div class="detail-list">${list}</div></div>`;
        }
        function setMode(show) { document.getElementById('detailToggle').checked = show; toggleDetails(); }
        function toggleDetails() { let show = document.getElementById('detailToggle').checked; document.querySelectorAll('.card-category').forEach(c => show ? c.classList.add('show-details') : c.classList.remove('show-details')); }
        function exportHistoryExcel() { /* åŒV17 */ alert("å»ºè­°ä½¿ç”¨å‚™ä»½åŠŸèƒ½ç¢ºä¿è³‡æ–™"); }
        function exportData() { let dataStr = JSON.stringify(dataStore); let blob = new Blob([dataStr], {type: "application/json"}); let url = URL.createObjectURL(blob); let a = document.createElement('a'); a.href = url; a.download = "money_backup_" + getTodayStr() + ".json"; a.click(); }
        function importData(input) { let file = input.files[0]; if(!file) return; let reader = new FileReader(); reader.onload = function(e) { try { if(confirm("ç¢ºå®šåŒ¯å…¥ï¼Ÿ")) { dataStore = JSON.parse(e.target.result); localStorage.setItem('myAssetData_v9_db', JSON.stringify(dataStore)); alert("åŒ¯å…¥æˆåŠŸï¼"); location.reload(); } } catch(err) { alert("æ ¼å¼éŒ¯èª¤"); } }; reader.readAsText(file); }
    </script>
</body>
</html>
