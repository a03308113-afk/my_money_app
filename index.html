<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„è³‡ç”¢è¡¨ (V24 FIREç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- é¢¨æ ¼è¨­å®š --- */
        :root {
            --bg-color: #F7F7F7;
            --card-bg: #FFFFFF;
            --text-main: #4A4A4A;
            --text-sub: #9B9B9B;
            --accent-color: #7D8668;
            --danger-color: #B85C5C;
            --info-bg: #E3E8E3;
            --border-color: #E0E0E0;
            --calc-bg: #F0F4F0;
            --fire-color: #E8AF20; /* è²¡å¯Œè‡ªç”±çš„é‡‘é»ƒè‰² */
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 120px; }
        .page { display: none; padding: 20px; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .header { text-align: center; font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; padding-top: 10px; color: var(--text-main); }
        .card { background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 20px; position: relative; }

        /* V24 FIRE å°ˆå€æ¨£å¼ */
        .fire-input-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #FFF8E1; padding: 10px; border-radius: 8px; border: 1px solid #FFE082; }
        .fire-label { font-size: 0.9rem; color: #8D6E63; font-weight: bold; }
        .fire-input { width: 90px; padding: 5px; border: 1px solid #FFE082; border-radius: 5px; text-align: right; color: #E65100; font-weight: bold; }
        .fire-result-box { text-align: center; margin: 20px 0; }
        .fire-target-text { font-size: 0.85rem; color: #888; margin-bottom: 5px; }
        .fire-target-num { font-size: 2rem; font-weight: 700; color: var(--fire-color); }
        .progress-container { background: #EEE; border-radius: 10px; height: 20px; width: 100%; margin: 15px 0; position: relative; overflow: hidden; }
        .progress-bar { background: var(--fire-color); height: 100%; width: 0%; transition: width 1s ease-in-out; border-radius: 10px; background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 1rem 1rem; }
        .progress-text { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; color: #555; font-weight: bold; white-space: nowrap; }
        .fire-stat-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 10px; border-top: 1px dashed #EEE; padding-top: 10px; }
        .fire-stat-val { font-weight: bold; }

        /* V23 è¶¨å‹¢åœ–æ§åˆ¶ */
        .trend-controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #EEE; }
        .trend-checkbox-label { display: flex; align-items: center; padding: 6px 10px; background: #FAFAFA; border: 1px solid #DDD; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .trend-checkbox-label.active { border-color: var(--accent-color); background: #F0F4F0; color: var(--accent-color); font-weight: bold; }
        .trend-checkbox-label input { margin-right: 6px; accent-color: var(--accent-color); }

        /* V21 åœ“é¤…åœ– */
        .pie-controls { margin-top: 20px; border-top: 1px dashed #EEE; padding-top: 15px; }
        .filter-group { margin-bottom: 10px; }
        .filter-header { display: flex; align-items: center; font-weight: bold; margin-bottom: 5px; cursor: pointer; font-size: 0.9rem; }
        .filter-items { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding-left: 20px; }
        .filter-item { display: flex; align-items: center; font-size: 0.85rem; color: #666; cursor: pointer; }
        .checkbox-custom { accent-color: var(--accent-color); margin-right: 5px; }
        .tag-retire { color: #E8AF20; } .tag-cash { color: #4A90E2; } .tag-stock { color: #7D8668; } .tag-prop { color: #9C27B0; }

        /* é€šç”¨å…ƒä»¶ */
        .date-picker-container { background: #FFF; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--accent-color); }
        .date-input { border: none; background: transparent; font-size: 1rem; color: var(--text-main); font-family: inherit; font-weight: bold; cursor: pointer; }
        .big-number { font-size: 2.2rem; font-weight: 700; margin: 10px 0; text-align: center; }
        .sub-number { font-size: 0.9rem; text-align: center; margin-bottom: 10px; font-weight: bold; }
        .section-title { font-size: 1rem; font-weight: bold; margin-bottom: 15px; color: var(--text-main); border-left: 4px solid var(--accent-color); padding-left: 10px; }
        .toggle-container { display: flex; justify-content: center; align-items: center; margin-bottom: 10px; font-size: 0.9rem; color: var(--text-sub); }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin: 0 10px;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #CCC; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        .card-category .detail-list { display: none; margin-top: 10px; border-top: 1px dashed #EEE; padding-top: 10px; }
        .card-category.show-details .detail-list { display: block !important; }
        .detail-item { display: flex; justify-content: space-between; font-size: 0.85rem; color: #888; margin-bottom: 6px; padding-left: 10px; }
        .dynamic-row { display: flex; align-items: center; margin-bottom: 8px; }
        .dynamic-name { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px 0 0 8px; background: #FAFAFA; font-size: 0.95rem; }
        .dynamic-val { width: 110px; padding: 10px; border: 1px solid var(--border-color); border-radius: 0 8px 8px 0; text-align: right; font-size: 1rem; }
        .btn-del { margin-left: 8px; color: #CCC; font-size: 1.2rem; cursor: pointer; padding: 5px; }
        .btn-add { width: 100%; padding: 10px; border: 1px dashed #CCC; color: #888; background: transparent; border-radius: 8px; cursor: pointer; margin-top: 5px; font-size: 0.9rem; }
        .btn-save { display: block; width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .memo-input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: #FFF; margin-bottom: 15px; min-height: 80px; resize: vertical; }
        .stock-row { background-color: var(--calc-bg); border-radius: 10px; padding: 10px; margin-bottom: 12px; border: 1px solid #E0E6E0; }
        .stock-name-row { display: flex; align-items: center; margin-bottom: 5px; }
        .stock-name-input { width: 100%; border: none; background: transparent; font-weight: bold; font-size: 0.95rem; color: var(--text-main); border-bottom: 1px dashed #CCC; padding-bottom: 3px; }
        .btn-search { background: #4A90E2; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 0.75rem; margin-right: 8px; cursor: pointer; }
        .stock-calc-row { display: flex; justify-content: space-between; align-items: center; gap: 5px; }
        .calc-group { display: flex; flex-direction: column; width: 30%; }
        .calc-input { width: 100%; padding: 5px; border: 1px solid #DDD; border-radius: 6px; text-align: center; }
        .stock-total-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(0,0,0,0.05); }
        .analysis-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #EEE; }
        .analysis-label { font-size: 0.95rem; font-weight: 500; color: #555; display: flex; align-items: center; }
        .trend-icon { margin-right: 8px; font-size: 1.1rem; width: 25px; text-align: center; display: inline-block;}
        .analysis-val { font-weight: bold; font-size: 1rem; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: #FFF; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #EEE; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: #C0C0C0; cursor: pointer; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .nav-item.active { color: var(--accent-color); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
        .backup-section { text-align: center; margin-top: 30px; border-top: 1px solid #EEE; padding-top: 20px; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .btn-action { padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; border: none; color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin: 5px;}
        .btn-excel { background-color: #217346; } .btn-backup { background-color: #607D8B; } .btn-import { background-color: #FFF; border: 1px solid #607D8B; color: #607D8B; }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <div class="header">è³‡ç”¢æˆ°æƒ…å®¤</div>
        <div class="date-picker-container" style="background-color: var(--info-bg); border: none;">
            <span style="font-size: 0.9rem; color: #556B55;">ğŸ“… æœˆä»½ï¼š</span>
            <input type="month" id="home-date-picker" class="date-input" onchange="loadHomeDataByDate(this.value)">
        </div>
        
        <div class="card">
            <div style="font-size:0.9rem; color:var(--text-sub); text-align:center;">æ·¨è³‡ç”¢ç¸½é¡</div>
            <div class="big-number" id="dash-net-worth">...</div>
            <div class="sub-number" id="dash-diff"></div>
        </div>

        <div class="card">
            <h3 class="section-title">ğŸ“Š è¼ƒä¸Šæœˆè®Šå‹•åˆ†æ</h3>
            <div id="analysis-container"></div>
        </div>

        <div class="card">
            <div class="toggle-container">
                <span onclick="setMode(false)" style="cursor:pointer;">éš±è—ç´°é …</span>
                <label class="switch"><input type="checkbox" id="detailToggle" onchange="toggleDetails()"><span class="slider"></span></label>
                <span onclick="setMode(true)" style="cursor:pointer;">é¡¯ç¤ºå…¨è²Œ</span>
            </div>
        </div>
        <div id="cards-container"></div>

        <div class="backup-section">
            <button class="btn-action btn-excel" onclick="exportHistoryExcel()">åŒ¯å‡ºå®Œæ•´æ­·å² Excel</button>
            <div>
                <button class="btn-action btn-backup" onclick="exportData()">å‚™ä»½æª”æ¡ˆ</button>
                <button class="btn-action btn-import" onclick="document.getElementById('importFile').click()">åŒ¯å…¥æª”æ¡ˆ</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
        </div>
        <div style="height: 30px;"></div>
    </div>

    <div id="page-input" class="page">
        <div class="header">è³‡ç”¢ç›¤é»</div>
        <div class="date-picker-container">
            <span style="font-size: 0.9rem; color: var(--accent-color);">ğŸ“… è¨˜å¸³æœˆä»½ï¼š</span>
            <input type="month" id="input-date-picker" class="date-input" onchange="loadInputDataByDate(this.value)">
        </div>
        <div style="margin-bottom: 20px;"><textarea id="input-memo" class="memo-input" placeholder="æœ¬æœˆé‡è¦ç­†è¨˜..."></textarea></div>
        <div id="section-assets"><div id="input-sections-assets"></div></div>
        <button class="btn-save" onclick="saveData()">å„²å­˜ç´€éŒ„</button>
        <div style="height:30px"></div>
    </div>

    <div id="page-trend" class="page">
        <div class="header">è²¡å‹™è¶¨å‹¢åˆ†æ</div>
        
        <div class="card">
            <div class="section-title">ğŸ“ˆ è‡ªé¸è¶¨å‹¢åˆ†æ (å¤šé¸)</div>
            <div class="trend-controls" id="trend-controls"></div>
            <div style="position: relative; height:300px; width:100%;">
                <canvas id="customTrendChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="section-title">ğŸ° è³‡ç”¢é…ç½® (åœ“é¤…åœ–)</div>
            <div style="position: relative; height:250px; width:100%;">
                <canvas id="allocationChart"></canvas>
            </div>
            <div class="pie-controls" id="pie-controls"></div>
        </div>

        <div class="card" style="border: 2px solid #E8AF20;">
            <div class="section-title" style="border-left-color:#E8AF20; color:#E8AF20;">ğŸ”¥ è²¡å¯Œè‡ªç”± (FIRE) æˆ°æƒ…å®¤</div>
            
            <div class="fire-input-group">
                <div class="fire-label">ç†æƒ³å¹´è¢«å‹•æ”¶å…¥</div>
                <div><input type="number" id="fire-income-goal" class="fire-input" value="600000" onchange="updateFIRE()"> å…ƒ</div>
            </div>
            <div class="fire-input-group">
                <div class="fire-label">é ä¼°æŠ•è³‡æ®–åˆ©ç‡</div>
                <div><input type="number" id="fire-yield" class="fire-input" value="5" onchange="updateFIRE()"> %</div>
            </div>

            <div class="fire-result-box">
                <div class="fire-target-text">é”æˆç›®æ¨™æ‰€éœ€æœ¬é‡‘ (FIRE Number)</div>
                <div class="fire-target-num" id="fire-target-num">$12,000,000</div>
            </div>

            <div style="font-size:0.8rem; color:#666; display:flex; justify-content:space-between;">
                <span>ç›®å‰é€€ä¼‘è³‡ç”¢ (è¨ˆç•«+ç¾é‡‘)</span>
                <span id="fire-current-assets" style="font-weight:bold;">$0</span>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="fire-progress-bar"></div>
                <div class="progress-text" id="fire-progress-text">0%</div>
            </div>

            <div class="fire-stat-row">
                <span>ç•¶å‰è¢«å‹•æ”¶å…¥ (é ä¼°)</span>
                <span class="fire-stat-val" style="color:var(--fire-color);" id="fire-passive-income">$0 / å¹´</span>
            </div>
            <div class="fire-stat-row">
                <span>è·é›¢ç›®æ¨™ç¼ºå£</span>
                <span class="fire-stat-val" id="fire-gap">$0</span>
            </div>
        </div>
        
        <div style="height:50px"></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('home')"><span class="nav-icon">â˜–</span><span>é¦–é </span></div>
        <div class="nav-item" onclick="switchPage('input')"><span class="nav-icon">âœ</span><span>è¨˜å¸³</span></div>
        <div class="nav-item" onclick="switchPage('trend')"><span class="nav-icon">ğŸ“Š</span><span>åˆ†æ</span></div>
    </div>

    <script>
        let dataStore = {}; let myPieChart = null; let myTrendChart = null; 
        // FIRE è¨­å®šé è¨­å€¼
        let fireSettings = { goal: 600000, yield: 5 };

        const defaultTemplate = {
            cash: [{name: "åœ‹æ³°ä¸–è¯", val: 0}, {name: "å°æ–° Richart", val: 0}],
            invest: [{name: "VOO (ç¾è‚¡)", val: 0, price:0, shares:0, exrate:32.5}, {name: "0050 (å°è‚¡)", val: 0, price:0, shares:0, exrate:1}],
            prop: [{name: "è‡ªç”¨ä½å®…", val: 0}],
            debt: [{name: "ä¿¡ç”¨å¡è²»", val: 0}, {name: "æˆ¿å±‹è²¸æ¬¾", val: 0}],
            memo: ""
        };

        const trendOptions = [
            { id: 'net', label: 'ğŸ’° æ·¨è³‡ç”¢', color: '#7D8668', checked: true, fn: (d) => getNetWorth(d) },
            { id: 'debt', label: 'ğŸ’¸ è² å‚µç¸½é¡', color: '#B85C5C', checked: false, fn: (d) => getSum(d.debt) },
            { id: 'card', label: 'ğŸ’³ ä¿¡ç”¨å¡è²»', color: '#FF5722', checked: false, fn: (d) => filterSum(d.debt, 'å¡') },
            { id: 'loan', label: 'ğŸ  æˆ¿è²¸', color: '#795548', checked: false, fn: (d) => filterSum(d.debt, 'æˆ¿è²¸') },
            { id: 'cash', label: 'ğŸ’µ ç¾é‡‘', color: '#4A90E2', checked: false, fn: (d) => getSum(d.cash) },
            { id: 'invest', label: 'ğŸ“ˆ æŠ•è³‡', color: '#E8AF20', checked: false, fn: (d) => getSum(d.invest) },
            { id: 'us_stock', label: 'ğŸ‡ºğŸ‡¸ ç¾è‚¡', color: '#3F51B5', checked: false, fn: (d) => filterSum(d.invest, 'ç¾è‚¡|VOO|QQQ|SPY') },
            { id: 'tw_stock', label: 'ğŸ‡¹ğŸ‡¼ å°è‚¡', color: '#009688', checked: false, fn: (d) => filterSum(d.invest, 'å°è‚¡|0050') }
        ];

        function filterSum(arr, keywordRegex) {
            let re = new RegExp(keywordRegex, 'i');
            return arr.filter(i => re.test(i.name)).reduce((a,b)=>a+b.val, 0);
        }

        window.onload = function() {
            let stored = localStorage.getItem('myAssetData_v9_db');
            if (stored) dataStore = JSON.parse(stored); else migrateOrInitData();
            
            // è¼‰å…¥ FIRE è¨­å®š
            let fs = localStorage.getItem('myFireSettings');
            if(fs) { 
                fireSettings = JSON.parse(fs); 
                document.getElementById('fire-income-goal').value = fireSettings.goal;
                document.getElementById('fire-yield').value = fireSettings.yield;
            }

            let today = new Date().toISOString().substring(0, 7);
            let targetDate = today;
            let dates = Object.keys(dataStore).sort();
            if (dates.length > 0) targetDate = dates[dates.length - 1];

            document.getElementById('home-date-picker').value = targetDate;
            document.getElementById('input-date-picker').value = targetDate;
            
            loadHomeDataByDate(targetDate);
            loadInputDataByDate(targetDate);
            renderCharts(); 
        };

        // --- V24 FIRE é‚è¼¯ ---
        function updateFIRE() {
            // 1. å–å¾—è¨­å®š
            let goal = Number(document.getElementById('fire-income-goal').value) || 600000;
            let yieldRate = Number(document.getElementById('fire-yield').value) || 5;
            fireSettings = { goal, yield: yieldRate };
            localStorage.setItem('myFireSettings', JSON.stringify(fireSettings));

            // 2. è¨ˆç®—ç›®æ¨™æœ¬é‡‘ (FIRE Number) = å¹´æ”¯å‡º / æ®–åˆ©ç‡
            let targetCapital = goal / (yieldRate / 100);
            document.getElementById('fire-target-num').innerText = '$' + (targetCapital/10000).toFixed(0) + 'è¬';

            // 3. è¨ˆç®—ç›®å‰é€€ä¼‘è³‡ç”¢ (æ¡ç”¨æœ€æ–°çš„æœˆä»½è³‡æ–™)
            let dates = Object.keys(dataStore).sort();
            if(dates.length === 0) return;
            let lastDate = dates[dates.length-1];
            let d = dataStore[lastDate];

            // é€€ä¼‘è³‡ç”¢ = é€€ä¼‘è¨ˆç•«ETF + ç¾é‡‘
            let retireInvest = getRetirementSum(d.invest);
            let cash = getSum(d.cash);
            let currentAssets = retireInvest + cash;

            document.getElementById('fire-current-assets').innerText = '$' + currentAssets.toLocaleString();

            // 4. è¨ˆç®—é€²åº¦
            let progress = Math.min((currentAssets / targetCapital) * 100, 100);
            let bar = document.getElementById('fire-progress-bar');
            bar.style.width = progress + '%';
            document.getElementById('fire-progress-text').innerText = progress.toFixed(1) + '%';
            
            // 5. é ä¼°è¢«å‹•æ”¶å…¥ & ç¼ºå£
            let estIncome = currentAssets * (yieldRate / 100);
            document.getElementById('fire-passive-income').innerText = '$' + Math.round(estIncome).toLocaleString() + ' / å¹´';
            
            let gap = targetCapital - currentAssets;
            document.getElementById('fire-gap').innerText = gap > 0 ? '$' + gap.toLocaleString() : 'å·²é”æˆï¼ğŸ‰';
        }

        function getRetirementSum(investList) {
            let keywords = ["VOO", "QQQ", "SPY", "0050", "å¤§ç›¤"];
            return investList.filter(item => {
                return keywords.some(k => item.name.toUpperCase().includes(k));
            }).reduce((a, b) => a + b.val, 0);
        }

        // --- V23 è¶¨å‹¢åœ–é‚è¼¯ ---
        function initTrendControls() {
            const container = document.getElementById('trend-controls');
            container.innerHTML = '';
            trendOptions.forEach(opt => {
                let label = document.createElement('label');
                label.className = 'trend-checkbox-label';
                if(opt.checked) label.classList.add('active');
                label.innerHTML = `<input type="checkbox" value="${opt.id}" ${opt.checked ? 'checked' : ''}>${opt.label}`;
                label.querySelector('input').addEventListener('change', function() {
                    opt.checked = this.checked;
                    if(this.checked) label.classList.add('active'); else label.classList.remove('active');
                    updateTrendChart();
                });
                container.appendChild(label);
            });
        }
        function updateTrendChart() {
            let dates = Object.keys(dataStore).sort(); if (dates.length === 0) return;
            let showData = dates.slice(-12);
            let labels = showData.map(d => d.substring(5));
            let datasets = [];
            trendOptions.forEach(opt => {
                if(opt.checked) {
                    let dataPoints = showData.map(d => opt.fn(dataStore[d]));
                    datasets.push({ label: opt.label, data: dataPoints, borderColor: opt.color, backgroundColor: opt.color, tension: 0.3, pointRadius: 3 });
                }
            });
            const ctx = document.getElementById('customTrendChart').getContext('2d');
            if (myTrendChart) myTrendChart.destroy();
            myTrendChart = new Chart(ctx, {
                type: 'line', data: { labels: labels, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { return context.dataset.label + ': $' + (context.raw/10000).toFixed(1) + 'è¬'; } } } }, scales: { y: { beginAtZero: false, ticks: { callback: function(value) { return (value/10000).toFixed(0) + 'è¬'; } } } } }
            });
        }

        function renderCharts() {
            let dates = Object.keys(dataStore).sort(); if (dates.length === 0) return;
            let targetDate = document.getElementById('home-date-picker').value || dates[dates.length-1];
            initTrendControls(); updateTrendChart();
            initPieControls(targetDate);
            updateFIRE(); // V24 æ–°å¢
        }

        // --- åœ“é¤…åœ–é‚è¼¯ (V21) ---
        function updatePieChart() {
            let selectedItems = [];
            document.querySelectorAll('.item-checkbox:checked').forEach(cb => { selectedItems.push({ cat: cb.dataset.cat, val: Number(cb.dataset.val), label: cb.dataset.label }); });
            let categories = { 'retire': { label: 'é€€ä¼‘è¨ˆç•«', val: 0, color: '#E8AF20' }, 'stock': { label: 'å…¶ä»–æŠ•è³‡', val: 0, color: '#7D8668' }, 'cash': { label: 'ç¾é‡‘', val: 0, color: '#4A90E2' }, 'prop': { label: 'æˆ¿ç”¢', val: 0, color: '#9C27B0' } };
            selectedItems.forEach(item => { if(categories[item.cat]) categories[item.cat].val += item.val; });
            let labels = [], data = [], colors = [];
            Object.values(categories).forEach(c => { if(c.val > 0) { labels.push(c.label); data.push(c.val); colors.push(c.color); } });
            const ctx = document.getElementById('allocationChart').getContext('2d');
            if (myPieChart) myPieChart.destroy();
            myPieChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; let value = context.raw || 0; let total = context.chart._metasets[context.datasetIndex].total; let percentage = Math.round((value / total) * 100) + '%'; return label + ': $' + (value/10000).toFixed(1) + 'è¬ (' + percentage + ')'; }}} } } });
        }
        function initPieControls(date) {
            let d = dataStore[date]; if(!d) return;
            const container = document.getElementById('pie-controls'); container.innerHTML = '';
            let groups = { 'retire': { label: 'ğŸ”¥ é€€ä¼‘è¨ˆç•«', items: [], color: 'tag-retire' }, 'stock': { label: 'ğŸ“ˆ å…¶ä»–æŠ•è³‡', items: [], color: 'tag-stock' }, 'cash': { label: 'ğŸ’° ç¾é‡‘', items: [], color: 'tag-cash' }, 'prop': { label: 'ğŸ  æˆ¿ç”¢', items: [], color: 'tag-prop' } };
            let keywords = ["VOO", "QQQ", "SPY", "0050", "å¤§ç›¤"];
            d.invest.forEach(i => { if(keywords.some(k => i.name.toUpperCase().includes(k))) groups.retire.items.push(i); else groups.stock.items.push(i); });
            groups.cash.items = d.cash; groups.prop.items = d.prop;
            Object.keys(groups).forEach(key => {
                let g = groups[key]; if(g.items.length === 0) return;
                let groupHtml = `<div class="filter-group"><div class="filter-header ${g.color}"><input type="checkbox" class="group-checkbox checkbox-custom" data-group="${key}" checked onchange="toggleGroup('${key}', this.checked)">${g.label}</div><div class="filter-items">`;
                g.items.forEach((item, idx) => { groupHtml += `<label class="filter-item"><input type="checkbox" class="item-checkbox checkbox-custom group-${key}" data-cat="${key}" data-val="${item.val}" data-label="${item.name}" checked onchange="updatePieChart()">${item.name}</label>`; });
                groupHtml += `</div></div>`; container.innerHTML += groupHtml;
            }); updatePieChart();
        }
        function toggleGroup(groupKey, isChecked) { document.querySelectorAll(`.group-${groupKey}`).forEach(cb => { cb.checked = isChecked; }); updatePieChart(); }

        // --- é€šç”¨ ---
        function getTodayStr() { return new Date().toISOString().substring(0, 7); }
        function migrateOrInitData() { dataStore["2026-01"] = JSON.parse(JSON.stringify(defaultTemplate)); localStorage.setItem('myAssetData_v9_db', JSON.stringify(dataStore)); }
        function saveData() { currentEditingData.memo = document.getElementById('input-memo').value; dataStore[currentEditingDate] = currentEditingData; localStorage.setItem('myAssetData_v9_db', JSON.stringify(dataStore)); alert(`å·²å„²å­˜ï¼`); loadHomeDataByDate(currentEditingDate); renderCharts(); switchPage('home'); }
        function getCategoryValue(data, cat) { if(cat === 'debt') return getSum(data.debt); if(cat === 'net') return getNetWorth(data); if(cat === 'cash') return getSum(data.cash); if(cat === 'invest') return getSum(data.invest); if(cat === 'card') return filterSum(data.debt, 'å¡'); if(cat === 'loan') return filterSum(data.debt, 'æˆ¿è²¸|ä¿¡è²¸'); return 0; }
        function getNetWorth(d) { return (getSum(d.cash)+getSum(d.invest)+getSum(d.prop)) - getSum(d.debt); }
        function loadInputDataByDate(date) { currentEditingDate = date; if (dataStore[date]) currentEditingData = JSON.parse(JSON.stringify(dataStore[date])); else { let dates = Object.keys(dataStore).sort(); if(dates.length > 0) currentEditingData = JSON.parse(JSON.stringify(dataStore[dates[dates.length-1]])); else currentEditingData = JSON.parse(JSON.stringify(defaultTemplate)); } if(currentEditingData.invest) { currentEditingData.invest.forEach(i => { if(i.price===undefined) i.price=0; if(i.shares===undefined) i.shares=0; if(i.exrate===undefined) i.exrate=1; }); } document.getElementById('input-memo').value = currentEditingData.memo || ""; renderAssetsInput(); }
        function renderAssetsInput() { const container = document.getElementById('input-sections-assets'); container.innerHTML = ''; ['cash', 'invest', 'prop', 'debt'].forEach(type => { let title = type==='cash'?'ğŸ’° ç¾é‡‘':(type==='invest'?'ğŸ“ˆ æŠ•è³‡':(type==='prop'?'ğŸ  ä¸å‹•ç”¢':'ğŸ’¸ è² å‚µ')); let html = `<div class="card"><div class="section-header">${title} <span id="total-${type}-edit" style="font-size:0.9rem; color:#888;">$0</span></div><div id="list-${type}">`; if(type === 'invest') currentEditingData[type].forEach((item, index) => html += buildStockRowHtml(index, item)); else currentEditingData[type].forEach((item, index) => html += buildRowHtml(type, index, item)); html += `</div><button class="btn-add" onclick="addRow('${type}')">+ æ–°å¢é …ç›®</button></div>`; container.innerHTML += html; }); updateEditTotals(); }
        function buildRowHtml(type, index, item) { return `<div class="dynamic-row"><input type="text" class="dynamic-name" value="${item.name}" onchange="updateSimpleData('${type}', ${index}, 'name', this.value)"><input type="number" class="dynamic-val" value="${item.val}" placeholder="0" onchange="updateSimpleData('${type}', ${index}, 'val', this.value)"><div class="btn-del" onclick="delRow('${type}', ${index})">Ã—</div></div>`; }
        function buildStockRowHtml(index, item) { return `<div class="stock-row"><div class="stock-name-row"><input type="text" class="stock-name-input" value="${item.name}" onchange="updateStockData(${index}, 'name', this.value)"><button class="btn-search" onclick="searchStockPrice(${index})">ğŸ” æŸ¥åƒ¹</button><div class="btn-del" onclick="delRow('invest', ${index})">Ã—</div></div><div class="stock-calc-row"><div class="calc-group"><label class="calc-label">è‚¡åƒ¹</label><input type="number" class="calc-input" value="${item.price||''}" placeholder="0" onchange="updateStockData(${index}, 'price', this.value)"></div><div style="color:#CCC;">Ã—</div><div class="calc-group"><label class="calc-label">è‚¡æ•¸</label><input type="number" class="calc-input" value="${item.shares||''}" placeholder="0" onchange="updateStockData(${index}, 'shares', this.value)"></div><div style="color:#CCC;">Ã—</div><div class="calc-group"><label class="calc-label">åŒ¯ç‡</label><input type="number" class="calc-input" value="${item.exrate||1}" placeholder="1" onchange="updateStockData(${index}, 'exrate', this.value)"></div></div><div class="stock-total-row"><span style="font-size:0.8rem;color:var(--accent-color);font-weight:bold;">= å¸‚å€¼</span><span style="font-weight:bold;">$${item.val.toLocaleString()}</span></div></div>`; }
        function searchStockPrice(index) { let item = currentEditingData.invest[index]; let stockName = item.name.replace(/\(.*\)/, ''); window.open(`https://www.google.com/search?q=${encodeURIComponent(`${stockName} stock price ${currentEditingDate}`)}`, '_blank'); }
        function updateSimpleData(type, index, key, val) { if(key === 'val') val = Number(val) || 0; currentEditingData[type][index][key] = val; updateEditTotals(); }
        function updateStockData(index, key, val) { let item = currentEditingData.invest[index]; if(key === 'name') item.name = val; else { item[key] = Number(val) || 0; item.val = Math.round(item.price * item.shares * item.exrate); } renderAssetsInput(); }
        function addRow(type) { if(type === 'invest') currentEditingData[type].push({name: "", val: 0, price: 0, shares: 0, exrate: 1}); else currentEditingData[type].push({name: "", val: 0}); renderAssetsInput(); }
        function delRow(type, index) { if(confirm("åˆªé™¤ï¼Ÿ")) { currentEditingData[type].splice(index, 1); renderAssetsInput(); } }
        function updateEditTotals() { ['cash', 'invest', 'prop', 'debt'].forEach(type => { let sum = currentEditingData[type].reduce((a, b) => a + b.val, 0); document.getElementById('total-' + type + '-edit').innerText = '$' + sum.toLocaleString(); }); }
        function getSum(arr) { return arr ? arr.reduce((a, b) => a + b.val, 0) : 0; }
        function switchPage(page) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); document.getElementById('page-' + page).classList.add('active'); if(page==='home') document.querySelectorAll('.nav-item')[0].classList.add('active'); if(page==='input') document.querySelectorAll('.nav-item')[1].classList.add('active'); if(page==='trend') { document.querySelectorAll('.nav-item')[2].classList.add('active'); renderCharts(); } }
        function loadHomeDataByDate(date) {
            let data = dataStore[date]; if (!data) { document.getElementById('dash-net-worth').innerText = "ç„¡è³‡æ–™"; document.getElementById('dash-diff').innerText = "--"; document.getElementById('analysis-container').innerHTML = "<div style='text-align:center;color:#999;padding:10px;'>ğŸ“­ æœ¬æœˆå°šæœªè¨˜å¸³</div>"; document.getElementById('cards-container').innerHTML = ""; return; }
            let netWorth = getNetWorth(data); document.getElementById('dash-net-worth').innerText = 'NT$ ' + netWorth.toLocaleString();
            let dates = Object.keys(dataStore).sort(); let currIdx = dates.indexOf(date); let diff = 0;
            if (currIdx > 0) { let prevD = dataStore[dates[currIdx - 1]]; let prevNet = getNetWorth(prevD); diff = netWorth - prevNet; let sign = diff >= 0 ? 'â–²' : 'â–¼'; let color = diff >= 0 ? 'var(--accent-color)' : 'var(--danger-color)'; document.getElementById('dash-diff').innerText = `${sign} è¼ƒä¸Šæœˆ ${diff >= 0 ? '+' : ''}${diff.toLocaleString()}`; document.getElementById('dash-diff').style.color = color; } else { document.getElementById('dash-diff').innerText = "åˆå§‹ç´€éŒ„"; }
            let diffCash = 0, diffInvest = 0, diffDebt = 0;
            if (currIdx > 0) { let prevData = dataStore[dates[currIdx - 1]]; diffCash = getSum(data.cash) - getSum(prevData.cash); diffInvest = getSum(data.invest) - getSum(prevData.invest); diffDebt = getSum(data.debt) - getSum(prevData.debt); }
            document.getElementById('analysis-container').innerHTML = `<div class="analysis-row"><span class="analysis-label">ğŸ’° ç¾é‡‘è®Šå‹•</span><span class="analysis-val" style="color:${diffCash>=0?'var(--accent-color)':'var(--danger-color)'}">${diffCash>=0?'+':''}${diffCash.toLocaleString()}</span></div><div class="analysis-row"><span class="analysis-label">ğŸ“ˆ æŠ•è³‡æç›Š</span><span class="analysis-val" style="color:${diffInvest>=0?'var(--accent-color)':'var(--danger-color)'}">${diffInvest>=0?'+':''}${diffInvest.toLocaleString()}</span></div><div class="analysis-row"><span class="analysis-label">ğŸ’¸ è² å‚µè®Šå‹•</span><span class="analysis-val" style="color:${diffDebt>0?'var(--danger-color)':'var(--accent-color)'}">${diffDebt>=0?'+':''}${diffDebt.toLocaleString()}</span></div>`;
            const container = document.getElementById('cards-container');
            container.innerHTML = `${createCard('ğŸ’° ç¾é‡‘è³‡ç”¢', getSum(data.cash), data.cash, false)}${createCard('ğŸ“ˆ æŠ•è³‡éƒ¨ä½', getSum(data.invest), data.invest, false)}${createCard('ğŸ  ä¸å‹•ç”¢', getSum(data.prop), data.prop, false)}${createCard('ğŸ’¸ è² å‚µç¸½é¡', getSum(data.debt), data.debt, true)}`;
            toggleDetails();
        }
        function createCard(title, total, items, isRed) { let color = isRed ? 'color:var(--danger-color);' : ''; let list = items.map(i => `<div class="detail-item"><span>${i.name||'--'}</span><span>$${i.val.toLocaleString()}</span></div>`).join(''); return `<div class="card card-category"><div style="display:flex; justify-content:space-between; font-weight:bold;"><span>${title}</span><span style="${color}">$${total.toLocaleString()}</span></div><div class="detail-list">${list}</div></div>`; }
        function setMode(show) { document.getElementById('detailToggle').checked = show; toggleDetails(); }
        function toggleDetails() { let show = document.getElementById('detailToggle').checked; document.querySelectorAll('.card-category').forEach(c => show ? c.classList.add('show-details') : c.classList.remove('show-details')); }
        function exportHistoryExcel() {
            let dates = Object.keys(dataStore).sort(); if (dates.length === 0) { alert("ç„¡è³‡æ–™"); return; }
            let assetRows = []; let allCashNames = new Set(), allInvestNames = new Set(), allPropNames = new Set(), allDebtNames = new Set();
            dates.forEach(d => { dataStore[d].cash.forEach(i => allCashNames.add(i.name)); dataStore[d].invest.forEach(i => allInvestNames.add(i.name)); dataStore[d].prop.forEach(i => allPropNames.add(i.name)); dataStore[d].debt.forEach(i => allDebtNames.add(i.name)); });
            dates.forEach(date => { let d = dataStore[date]; let net = getNetWorth(d); let row = { "æœˆä»½": date, "æ·¨è³‡ç”¢ç¸½é¡": net, "ç¾é‡‘ç¸½é¡": getSum(d.cash), "æŠ•è³‡ç¸½é¡": getSum(d.invest), "ä¸å‹•ç”¢ç¸½é¡": getSum(d.prop), "è² å‚µç¸½é¡": getSum(d.debt) };
                allCashNames.forEach(n => row[`ç¾é‡‘_${n}`] = (d.cash.find(i=>i.name===n)||{}).val || 0); allInvestNames.forEach(n => row[`æŠ•è³‡_${n}`] = (d.invest.find(i=>i.name===n)||{}).val || 0); allPropNames.forEach(n => row[`æˆ¿ç”¢_${n}`] = (d.prop.find(i=>i.name===n)||{}).val || 0); allDebtNames.forEach(n => row[`è² å‚µ_${n}`] = (d.debt.find(i=>i.name===n)||{}).val || 0); row["å‚™å¿˜éŒ„"] = d.memo; assetRows.push(row); });
            let wb = XLSX.utils.book_new(); let ws1 = XLSX.utils.json_to_sheet(assetRows); XLSX.utils.book_append_sheet(wb, ws1, "æ­·å²è³‡ç”¢ç´€éŒ„"); XLSX.writeFile(wb, "æˆ‘çš„è³‡ç”¢å…¨ç´€éŒ„.xlsx");
        }
        function exportData() { let dataStr = JSON.stringify(dataStore); let blob = new Blob([dataStr], {type: "application/json"}); let url = URL.createObjectURL(blob); let a = document.createElement('a'); a.href = url; a.download = "money_backup_" + getTodayStr() + ".json"; a.click(); }
        function importData(input) { let file = input.files[0]; if(!file) return; let reader = new FileReader(); reader.onload = function(e) { try { if(confirm("ç¢ºå®šåŒ¯å…¥ï¼Ÿ")) { dataStore = JSON.parse(e.target.result); localStorage.setItem('myAssetData_v9_db', JSON.stringify(dataStore)); alert("åŒ¯å…¥æˆåŠŸï¼"); location.reload(); } } catch(err) { alert("æ ¼å¼éŒ¯èª¤"); } }; reader.readAsText(file); }
    </script>
</body>
</html>
