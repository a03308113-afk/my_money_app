<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„è³‡ç”¢è¡¨ (V20 æˆ°ç•¥ç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- é¢¨æ ¼è¨­å®š --- */
        :root {
            --bg-color: #F7F7F7;
            --card-bg: #FFFFFF;
            --text-main: #4A4A4A;
            --text-sub: #9B9B9B;
            --accent-color: #7D8668;   /* æŠ¹èŒ¶ç¶  */
            --danger-color: #B85C5C;   /* è±†æ²™ç´… */
            --goal-line: #E8AF20;      /* ç›®æ¨™ç·šé‡‘é»ƒè‰² */
            --link-blue: #4A90E2;
            --border-color: #E0E0E0;
            --calc-bg: #F0F4F0;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 120px; }
        .page { display: none; padding: 20px; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .header { text-align: center; font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; padding-top: 10px; color: var(--text-main); }
        .card { background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 20px; position: relative; }

        /* é€šç”¨å…ƒä»¶ */
        .date-picker-container { background: #FFF; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--accent-color); }
        .date-input { border: none; background: transparent; font-size: 1rem; color: var(--text-main); font-family: inherit; font-weight: bold; cursor: pointer; }
        .big-number { font-size: 2.2rem; font-weight: 700; margin: 10px 0; text-align: center; }
        .sub-number { font-size: 0.9rem; text-align: center; margin-bottom: 10px; font-weight: bold; }
        .section-title { font-size: 1rem; font-weight: bold; margin-bottom: 15px; color: var(--text-main); border-left: 4px solid var(--accent-color); padding-left: 10px; }

        /* V20 æ¯”è¼ƒå·¥å…·æ¨£å¼ */
        .compare-tools { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .compare-row { display: flex; justify-content: space-between; align-items: center; gap: 5px; }
        .compare-select { flex: 1; padding: 8px; border: 1px solid #DDD; border-radius: 8px; background: #FAFAFA; font-size: 0.9rem; }
        .compare-result { background: #F8F9FA; padding: 15px; border-radius: 10px; text-align: center; border: 1px dashed #CCC; }
        .compare-val { font-size: 1.5rem; font-weight: bold; margin: 5px 0; }
        .compare-diff { font-size: 0.9rem; font-weight: bold; }

        /* V20 ç›®æ¨™è¨­å®šæ¨£å¼ */
        .goal-input-container { display: flex; align-items: center; justify-content: flex-end; margin-bottom: 10px; font-size: 0.85rem; color: #888; }
        .goal-input { width: 100px; padding: 5px; margin-left: 5px; border: 1px solid #DDD; border-radius: 5px; text-align: right; }

        /* åœ–è¡¨æ¨£å¼ (å¢å¼·ç‰ˆ) */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 220px; padding-top: 30px; border-bottom: 1px solid #EEE; position: relative; margin-bottom: 20px;}
        .zero-line { position: absolute; left: 0; right: 0; top: 0; border-top: 1px dashed #CCC; z-index: 0; } /* JSæ§åˆ¶ä½ç½® */
        .goal-line { position: absolute; left: 0; right: 0; border-top: 2px dashed var(--goal-line); z-index: 2; display: flex; align-items: center; }
        .goal-label { position: absolute; right: 0; top: -20px; background: var(--goal-line); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        
        .bar-wrapper { width: 15%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; position: relative; z-index: 1; }
        .bar-container { height: 100%; width: 100%; display: flex; align-items: flex-end; position: relative; } /* JSæ§åˆ¶å°é½Š */
        .bar { width: 100%; transition: height 0.5s ease; opacity: 0.9; position: relative; }
        .bar.positive { background: var(--accent-color); border-radius: 4px 4px 0 0; }
        .bar.negative { background: var(--danger-color); border-radius: 0 0 4px 4px; }
        .bar-label { position: absolute; bottom: -25px; font-size: 0.75rem; color: #999; width: 100%; text-align: center; }
        .bar-val-text { position: absolute; font-size: 0.6rem; font-weight: bold; width: 140%; left: -20%; text-align: center; color: #666; }

        /* è¼¸å…¥èˆ‡ç´°ç¯€åˆ—è¡¨ */
        .toggle-container { display: flex; justify-content: center; align-items: center; margin-bottom: 10px; font-size: 0.9rem; color: var(--text-sub); }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin: 0 10px;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #CCC; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        .card-category .detail-list { display: none; margin-top: 10px; border-top: 1px dashed #EEE; padding-top: 10px; }
        .card-category.show-details .detail-list { display: block !important; }
        .detail-item { display: flex; justify-content: space-between; font-size: 0.85rem; color: #888; margin-bottom: 6px; padding-left: 10px; }

        .dynamic-row { display: flex; align-items: center; margin-bottom: 8px; }
        .dynamic-name { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px 0 0 8px; background: #FAFAFA; font-size: 0.95rem; }
        .dynamic-val { width: 110px; padding: 10px; border: 1px solid var(--border-color); border-radius: 0 8px 8px 0; text-align: right; font-size: 1rem; }
        .btn-del { margin-left: 8px; color: #CCC; font-size: 1.2rem; cursor: pointer; padding: 5px; }
        .btn-add { width: 100%; padding: 10px; border: 1px dashed #CCC; color: #888; background: transparent; border-radius: 8px; cursor: pointer; margin-top: 5px; font-size: 0.9rem; }
        .btn-save { display: block; width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .memo-input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: #FFF; margin-bottom: 15px; min-height: 80px; resize: vertical; }
        .info-board { background-color: var(--info-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px; color: #556B55; font-size: 0.9rem; position: relative; }
        .analysis-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #EEE; }
        .analysis-label { font-size: 0.95rem; font-weight: 500; color: #555; }
        .analysis-val { font-weight: bold; font-size: 1rem; }

        /* æŠ•è³‡è¨ˆç®—æ©Ÿ */
        .stock-row { background-color: var(--calc-bg); border-radius: 10px; padding: 10px; margin-bottom: 12px; border: 1px solid #E0E6E0; }
        .stock-name-row { display: flex; align-items: center; margin-bottom: 5px; }
        .stock-name-input { width: 100%; border: none; background: transparent; font-weight: bold; font-size: 0.95rem; color: var(--text-main); border-bottom: 1px dashed #CCC; padding-bottom: 3px; }
        .btn-search { background: var(--link-blue); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 0.75rem; margin-right: 8px; cursor: pointer; }
        .stock-calc-row { display: flex; justify-content: space-between; align-items: center; gap: 5px; }
        .calc-group { display: flex; flex-direction: column; width: 30%; }
        .calc-input { width: 100%; padding: 5px; border: 1px solid #DDD; border-radius: 6px; text-align: center; }
        .stock-total-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(0,0,0,0.05); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: #FFF; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #EEE; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: #C0C0C0; cursor: pointer; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .nav-item.active { color: var(--accent-color); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }

        .backup-section { text-align: center; margin-top: 30px; border-top: 1px solid #EEE; padding-top: 20px; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .btn-action { padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; border: none; color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin: 5px;}
        .btn-excel { background-color: #217346; }
        .btn-backup { background-color: #607D8B; }
        .btn-import { background-color: #FFF; border: 1px solid #607D8B; color: #607D8B; }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <div class="header">è³‡ç”¢æˆ°æƒ…å®¤</div>
        <div class="date-picker-container" style="background-color: var(--info-bg); border: none;">
            <span style="font-size: 0.9rem; color: #556B55;">ğŸ“… æœˆä»½ï¼š</span>
            <input type="month" id="home-date-picker" class="date-input" onchange="loadHomeDataByDate(this.value)">
        </div>
        
        <div class="card">
            <div style="font-size:0.9rem; color:var(--text-sub); text-align:center;">æ·¨è³‡ç”¢ç¸½é¡</div>
            <div class="big-number" id="dash-net-worth">...</div>
            <div class="sub-number" id="dash-diff"></div>
        </div>

        <div class="card">
            <h3 class="section-title">ğŸ“Š è¼ƒä¸Šæœˆè®Šå‹•åˆ†æ</h3>
            <div id="analysis-container"></div>
        </div>

        <div class="card">
            <div class="toggle-container">
                <span onclick="setMode(false)" style="cursor:pointer;">éš±è—ç´°é …</span>
                <label class="switch"><input type="checkbox" id="detailToggle" onchange="toggleDetails()"><span class="slider"></span></label>
                <span onclick="setMode(true)" style="cursor:pointer;">é¡¯ç¤ºå…¨è²Œ</span>
            </div>
        </div>
        <div id="cards-container"></div>

        <div class="backup-section">
            <button class="btn-action btn-excel" onclick="exportHistoryExcel()">åŒ¯å‡ºå®Œæ•´æ­·å² Excel</button>
            <div>
                <button class="btn-action btn-backup" onclick="exportData()">å‚™ä»½æª”æ¡ˆ</button>
                <button class="btn-action btn-import" onclick="document.getElementById('importFile').click()">åŒ¯å…¥æª”æ¡ˆ</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
        </div>
        <div style="height: 30px;"></div>
    </div>

    <div id="page-input" class="page">
        <div class="header">è³‡ç”¢ç›¤é»</div>
        <div class="date-picker-container">
            <span style="font-size: 0.9rem; color: var(--accent-color);">ğŸ“… è¨˜å¸³æœˆä»½ï¼š</span>
            <input type="month" id="input-date-picker" class="date-input" onchange="loadInputDataByDate(this.value)">
        </div>
        
        <div style="margin-bottom: 20px;"><textarea id="input-memo" class="memo-input" placeholder="æœ¬æœˆé‡è¦ç­†è¨˜..."></textarea></div>
        <div id="section-assets"><div id="input-sections-assets"></div></div>
        <button class="btn-save" onclick="saveData()">å„²å­˜ç´€éŒ„</button>
        <div style="height:30px"></div>
    </div>

    <div id="page-trend" class="page">
        <div class="header">è²¡å‹™è¶¨å‹¢åˆ†æ</div>
        
        <div class="card">
            <div class="section-title">ğŸ† æ·¨è³‡ç”¢ç›®æ¨™è¿½è¹¤</div>
            <div class="goal-input-container">
                è¨­å®šç›®æ¨™ï¼š<input type="number" id="net-worth-goal" class="goal-input" placeholder="ä¾‹å¦‚ 5000000" onchange="saveGoal()">
            </div>
            <div class="chart-container" id="net-worth-chart"></div>
        </div>

        <div class="card">
            <div class="section-title">ğŸ”¥ é€€ä¼‘è¨ˆç•« (å¤§ç›¤ ETF)</div>
            <div style="font-size:0.85rem; color:#666; margin-bottom:10px;">è¿½è¹¤æ¨™çš„ï¼šVOO, QQQ, SPY, 0050, å¤§ç›¤</div>
            <div class="chart-container" id="retirement-chart"></div>
        </div>

        <div class="card">
            <div class="section-title">âš–ï¸ æ­·å²æ¯”è¼ƒå·¥å…·</div>
            <div class="compare-tools">
                <div class="compare-row">
                    <span>åŸºæº–æœˆ A</span>
                    <select id="compare-month-a" class="compare-select" onchange="updateComparison()"></select>
                </div>
                <div class="compare-row">
                    <span>æ¯”è¼ƒæœˆ B</span>
                    <select id="compare-month-b" class="compare-select" onchange="updateComparison()"></select>
                </div>
                <div class="compare-row">
                    <span>æ¯”è¼ƒé …ç›®</span>
                    <select id="compare-category" class="compare-select" onchange="updateComparison()">
                        <option value="debt">ğŸ’¸ è² å‚µç¸½é¡</option>
                        <option value="card">ğŸ’³ ä¿¡ç”¨å¡è²»</option>
                        <option value="loan">ğŸ  æˆ¿è²¸/ä¿¡è²¸</option>
                        <option value="net">ğŸ’° æ·¨è³‡ç”¢</option>
                        <option value="cash">ğŸ’µ ç¾é‡‘éƒ¨ä½</option>
                    </select>
                </div>
            </div>
            <div class="compare-result">
                <div style="font-size:0.8rem; color:#888;">å·®ç•° (B - A)</div>
                <div class="compare-val" id="compare-val">0</div>
                <div class="compare-diff" id="compare-diff">--</div>
            </div>
        </div>
        
        <div style="height:50px"></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('home')"><span class="nav-icon">â˜–</span><span>é¦–é </span></div>
        <div class="nav-item" onclick="switchPage('input')"><span class="nav-icon">âœ</span><span>è¨˜å¸³</span></div>
        <div class="nav-item" onclick="switchPage('trend')"><span class="nav-icon">ğŸ“Š</span><span>åˆ†æ</span></div>
    </div>

    <script>
        // --- V20 æ ¸å¿ƒ ---
        let dataStore = {}; 
        let userGoal = 0; // ä½¿ç”¨è€…ç›®æ¨™

        // é è¨­æ¨£æ¿
        const defaultTemplate = {
            cash: [{name: "åœ‹æ³°ä¸–è¯", val: 0}, {name: "å°æ–° Richart", val: 0}, {name: "ç¾é‡‘éŒ¢åŒ…", val: 0}],
            invest: [{name: "VOO (ç¾è‚¡å¤§ç›¤)", val: 0, price:0, shares:0, exrate:32.5}, {name: "0050 (å°è‚¡å¤§ç›¤)", val: 0, price:0, shares:0, exrate:1}],
            prop: [{name: "è‡ªç”¨ä½å®…", val: 0}],
            debt: [{name: "ä¿¡ç”¨å¡è²»", val: 0}, {name: "æˆ¿å±‹è²¸æ¬¾", val: 0}],
            memo: ""
        };

        window.onload = function() {
            // è¼‰å…¥è³‡æ–™
            let stored = localStorage.getItem('myAssetData_v9_db');
            if (stored) dataStore = JSON.parse(stored);
            else migrateOrInitData();

            // è¼‰å…¥ç›®æ¨™
            let goal = localStorage.getItem('myAssetGoal');
            if(goal) { userGoal = Number(goal); document.getElementById('net-worth-goal').value = userGoal; }

            // é è¨­æ—¥æœŸ
            let today = new Date().toISOString().substring(0, 7);
            let targetDate = today;
            let dates = Object.keys(dataStore).sort();
            if (dates.length > 0) targetDate = dates[dates.length - 1];

            document.getElementById('home-date-picker').value = targetDate;
            document.getElementById('input-date-picker').value = targetDate;
            
            // æ¸²æŸ“
            loadHomeDataByDate(targetDate);
            loadInputDataByDate(targetDate);
            initComparison(); // åˆå§‹åŒ–æ¯”è¼ƒå·¥å…·
            renderCharts();   // ç•«åœ–
        };

        // --- è³‡æ–™è™•ç†å€ ---
        function getTodayStr() { return new Date().toISOString().substring(0, 7); }
        function migrateOrInitData() {
            // å‡è³‡æ–™è®“ä½ å¯ä»¥æ¸¬è©¦
            dataStore["2025-11"] = JSON.parse(JSON.stringify(defaultTemplate));
            dataStore["2025-11"].debt[1].val = 12000000; // æˆ¿è²¸
            dataStore["2026-01"] = JSON.parse(JSON.stringify(defaultTemplate)); 
            dataStore["2026-01"].debt[1].val = 11800000;
            localStorage.setItem('myAssetData_v9_db', JSON.stringify(dataStore));
        }
        function saveData() {
            currentEditingData.memo = document.getElementById('input-memo').value;
            dataStore[currentEditingDate] = currentEditingData;
            localStorage.setItem('myAssetData_v9_db', JSON.stringify(dataStore));
            alert(`å·²å„²å­˜ï¼`);
            loadHomeDataByDate(currentEditingDate);
            renderCharts();
            initComparison(); // æ›´æ–°ä¸‹æ‹‰é¸å–®
            switchPage('home');
        }
        function saveGoal() {
            userGoal = Number(document.getElementById('net-worth-goal').value);
            localStorage.setItem('myAssetGoal', userGoal);
            renderCharts(); // é‡ç•«åœ–è¡¨ä»¥é¡¯ç¤ºç›®æ¨™ç·š
        }

        // --- V20 æ–°å¢ï¼šæ¯”è¼ƒå·¥å…·é‚è¼¯ ---
        function initComparison() {
            let dates = Object.keys(dataStore).sort().reverse(); // æ–°åˆ°èˆŠ
            let selA = document.getElementById('compare-month-a');
            let selB = document.getElementById('compare-month-b');
            selA.innerHTML = ''; selB.innerHTML = '';
            
            dates.forEach(d => {
                let optA = new Option(d, d);
                let optB = new Option(d, d);
                selA.add(optA);
                selB.add(optB);
            });
            
            // é è¨­é¸æœ€è¿‘å…©å€‹æœˆ
            if(dates.length >= 2) {
                selA.value = dates[1]; // èˆŠ
                selB.value = dates[0]; // æ–°
            }
            updateComparison();
        }

        function updateComparison() {
            let dateA = document.getElementById('compare-month-a').value;
            let dateB = document.getElementById('compare-month-b').value;
            let cat = document.getElementById('compare-category').value;
            
            if(!dateA || !dateB || !dataStore[dateA] || !dataStore[dateB]) return;

            let valA = getCategoryValue(dataStore[dateA], cat);
            let valB = getCategoryValue(dataStore[dateB], cat);
            let diff = valB - valA;
            let percent = valA !== 0 ? ((diff / Math.abs(valA)) * 100).toFixed(1) : 0;

            let color = diff > 0 ? "var(--danger-color)" : "var(--accent-color)"; // é è¨­ç´…æ˜¯å¢åŠ (ä¸å¥½)ï¼Œç¶ æ˜¯æ¸›å°‘
            // å¦‚æœæ˜¯æ·¨è³‡ç”¢æˆ–ç¾é‡‘ï¼Œé‚è¼¯ç›¸å
            if(cat === 'net' || cat === 'cash') {
                color = diff >= 0 ? "var(--accent-color)" : "var(--danger-color)";
            }

            document.getElementById('compare-val').innerText = (diff>=0?'+':'') + diff.toLocaleString();
            document.getElementById('compare-val').style.color = color;
            document.getElementById('compare-diff').innerText = `${percent}%`;
        }

        function getCategoryValue(data, cat) {
            if(cat === 'debt') return getSum(data.debt);
            if(cat === 'net') return (getSum(data.cash)+getSum(data.invest)+getSum(data.prop)) - getSum(data.debt);
            if(cat === 'cash') return getSum(data.cash);
            if(cat === 'card') {
                // æ¨¡ç³Šæœå°‹åç¨±å«"ä¿¡ç”¨å¡"æˆ–"å¡è²»"
                return data.debt.filter(i => i.name.includes("ä¿¡ç”¨å¡") || i.name.includes("å¡è²»")).reduce((a,b)=>a+b.val,0);
            }
            if(cat === 'loan') {
                return data.debt.filter(i => i.name.includes("è²¸")).reduce((a,b)=>a+b.val,0);
            }
            return 0;
        }

        // --- V20 æ–°å¢ï¼šåœ–è¡¨ç¹ªè£½ (å«ç›®æ¨™ç·š & é€€ä¼‘ETF) ---
        function renderCharts() {
            let dates = Object.keys(dataStore).sort();
            if (dates.length === 0) return;
            let showData = dates.slice(-5); // å–æœ€å¾Œ5ç­†

            // 1. æ·¨è³‡ç”¢åœ– (å«ç›®æ¨™ç·š)
            drawCustomBarChart('net-worth-chart', showData, (d) => {
                return (getSum(dataStore[d].cash) + getSum(dataStore[d].invest) + getSum(dataStore[d].prop)) - getSum(dataStore[d].debt);
            }, userGoal);

            // 2. é€€ä¼‘è¨ˆç•«åœ– (åªæŠ“ç‰¹å®šé—œéµå­—)
            drawCustomBarChart('retirement-chart', showData, (d) => {
                return getRetirementSum(dataStore[d].invest);
            }, 0); // é€™è£¡æš«æ™‚ä¸è¨­ç›®æ¨™ç·šï¼Œæˆ–ä½ å¯ä»¥å†åŠ ä¸€å€‹è¼¸å…¥æ¡†
        }

        function getRetirementSum(investList) {
            // é—œéµå­—ç™½åå–®
            let keywords = ["VOO", "QQQ", "SPY", "0050", "å¤§ç›¤"];
            return investList.filter(item => {
                return keywords.some(k => item.name.toUpperCase().includes(k));
            }).reduce((a, b) => a + b.val, 0);
        }

        function drawCustomBarChart(containerId, dates, valueFn, goalValue) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            let values = dates.map(d => valueFn(d));
            // æ±ºå®š Y è»¸æœ€å¤§å€¼ï¼šè¦åŒ…å«æ•¸æ“šæœ€å¤§å€¼ï¼Œä¹Ÿè¦åŒ…å«ç›®æ¨™å€¼
            let maxVal = Math.max(...values);
            if(goalValue > 0) maxVal = Math.max(maxVal, goalValue);
            if(maxVal === 0) maxVal = 100; // é¿å…åˆ†æ¯ç‚º0

            // ç¹ªè£½ç›®æ¨™ç·š (å¦‚æœæœ‰çš„è©±)
            if(goalValue > 0) {
                let goalH = (goalValue / maxVal) * 80; // ç•™ 20% é ­éƒ¨ç©ºé–“
                let goalLine = document.createElement('div');
                goalLine.className = 'goal-line';
                goalLine.style.bottom = goalH + '%';
                goalLine.innerHTML = `<div class="goal-label">ç›®æ¨™ $${(goalValue/10000).toFixed(0)}è¬</div>`;
                container.appendChild(goalLine);
            }

            // ç¹ªè£½ 0 ç·š (åŸºæº–ç·š)
            let zeroLine = document.createElement('div');
            zeroLine.className = 'zero-line';
            // ç°¡å–®è™•ç†ï¼šå¦‚æœéƒ½æ˜¯æ­£æ•¸ï¼Œ0ç·šåœ¨åº•éƒ¨ï¼›å¦‚æœæœ‰è² æ•¸ï¼Œè¦è¨ˆç®—ä½ç½®ã€‚é€™è£¡ç°¡åŒ–å‡è¨­è³‡ç”¢å¤šç‚ºæ­£ã€‚
            let minVal = Math.min(...values);
            let baseline = 0;
            if (minVal < 0) {
                // å¦‚æœæœ‰è² å€¼ï¼Œéœ€è¦èª¿æ•´ 0 ç·šä½ç½®
                // é€™è£¡ç‚ºäº†ä¿æŒ V20 ç°¡æ½”ï¼Œæš«æ™‚ä»¥çµ•å°åº•éƒ¨ç‚º 0 (é©åˆè³‡ç”¢)ï¼Œè‹¥æœ‰è² å‚µåœ–å¯èƒ½éœ€èª¿æ•´
                // ä½†å› ç‚ºæ˜¯ç•«æ·¨è³‡ç”¢ï¼Œé€šå¸¸å¸Œæœ›æ˜¯æ­£çš„ã€‚è‹¥ç‚ºè² ï¼ŒBar æœƒå¾€ä¸‹é•· (CSS éœ€é…åˆ)
                // ç‚ºäº†ä¸è®“ç¨‹å¼ç¢¼å¤ªè¤‡é›œï¼Œæˆ‘å€‘æ¡ç”¨ "æ­£å€¼å¾€ä¸Šï¼Œè² å€¼ä¸é¡¯ç¤ºæˆ–é¡¯ç¤ºæ¥µå°" çš„ç°¡æ˜“é¡¯ç¤ºï¼Œ
                // æˆ–è€…å¯ä»¥æŠŠ minVal ç´å…¥ range è¨ˆç®—ã€‚
            }
            container.appendChild(zeroLine); // é è¨­åº•éƒ¨

            dates.forEach((d, i) => {
                let val = values[i];
                let h = (val / maxVal) * 80; // é«˜åº¦æ¯”ä¾‹
                if(h < 1 && val > 0) h = 1;
                
                let wrapper = document.createElement('div');
                wrapper.className = 'bar-wrapper';
                
                let barClass = val >= 0 ? 'positive' : 'negative';
                let barHtml = `<div class="bar ${barClass}" style="height:${Math.abs(h)}%;"></div>`;
                let textHtml = `<div class="bar-val-text" style="bottom:${Math.abs(h)+2}%">${(val/10000).toFixed(0)}è¬</div>`;
                
                wrapper.innerHTML = `
                    <div class="bar-container">
                        ${barHtml} ${textHtml}
                    </div>
                    <div class="bar-label">${d.substring(5)}æœˆ</div>
                `;
                container.appendChild(wrapper);
            });
        }

        // --- å…¶ä»–é€šç”¨åŠŸèƒ½ (æ²¿ç”¨ V19) ---
        function loadInputDataByDate(date) {
            currentEditingDate = date;
            if (dataStore[date]) currentEditingData = JSON.parse(JSON.stringify(dataStore[date]));
            else {
                let dates = Object.keys(dataStore).sort();
                if(dates.length > 0) currentEditingData = JSON.parse(JSON.stringify(dataStore[dates[dates.length-1]]));
                else currentEditingData = JSON.parse(JSON.stringify(defaultTemplate));
            }
            // è£œå…¨æ¬„ä½
            if(currentEditingData.invest) {
                currentEditingData.invest.forEach(i => {
                    if(i.price===undefined) i.price=0; if(i.shares===undefined) i.shares=0; if(i.exrate===undefined) i.exrate=1;
                });
            }
            document.getElementById('input-memo').value = currentEditingData.memo || "";
            renderAssetsInput();
        }

        function renderAssetsInput() {
            const container = document.getElementById('input-sections-assets'); container.innerHTML = '';
            ['cash', 'invest', 'prop', 'debt'].forEach(type => {
                let title = type==='cash'?'ğŸ’° ç¾é‡‘':(type==='invest'?'ğŸ“ˆ æŠ•è³‡':(type==='prop'?'ğŸ  ä¸å‹•ç”¢':'ğŸ’¸ è² å‚µ'));
                let html = `<div class="card"><div class="section-header">${title} <span id="total-${type}-edit" style="font-size:0.9rem; color:#888;">$0</span></div><div id="list-${type}">`;
                
                if(type === 'invest') {
                    currentEditingData[type].forEach((item, index) => html += buildStockRowHtml(index, item));
                } else {
                    currentEditingData[type].forEach((item, index) => html += buildRowHtml(type, index, item));
                }
                html += `</div><button class="btn-add" onclick="addRow('${type}')">+ æ–°å¢é …ç›®</button></div>`;
                container.innerHTML += html;
            });
            updateEditTotals();
        }

        function buildRowHtml(type, index, item) {
            return `<div class="dynamic-row"><input type="text" class="dynamic-name" value="${item.name}" onchange="updateSimpleData('${type}', ${index}, 'name', this.value)"><input type="number" class="dynamic-val" value="${item.val}" placeholder="0" onchange="updateSimpleData('${type}', ${index}, 'val', this.value)"><div class="btn-del" onclick="delRow('${type}', ${index})">Ã—</div></div>`;
        }
        function buildStockRowHtml(index, item) {
            return `<div class="stock-row"><div class="stock-name-row"><input type="text" class="stock-name-input" value="${item.name}" onchange="updateStockData(${index}, 'name', this.value)"><button class="btn-search" onclick="searchStockPrice(${index})">ğŸ” æŸ¥åƒ¹</button><div class="btn-del" onclick="delRow('invest', ${index})">Ã—</div></div><div class="stock-calc-row"><div class="calc-group"><label class="calc-label">è‚¡åƒ¹</label><input type="number" class="calc-input" value="${item.price||''}" placeholder="0" onchange="updateStockData(${index}, 'price', this.value)"></div><div style="color:#CCC;">Ã—</div><div class="calc-group"><label class="calc-label">è‚¡æ•¸</label><input type="number" class="calc-input" value="${item.shares||''}" placeholder="0" onchange="updateStockData(${index}, 'shares', this.value)"></div><div style="color:#CCC;">Ã—</div><div class="calc-group"><label class="calc-label">åŒ¯ç‡</label><input type="number" class="calc-input" value="${item.exrate||1}" placeholder="1" onchange="updateStockData(${index}, 'exrate', this.value)"></div></div><div class="stock-total-row"><span style="font-size:0.8rem;color:var(--accent-color);font-weight:bold;">= å¸‚å€¼</span><span style="font-weight:bold;">$${item.val.toLocaleString()}</span></div></div>`;
        }
        
        function searchStockPrice(index) {
            let item = currentEditingData.invest[index];
            let stockName = item.name.replace(/\(.*\)/, '');
            window.open(`https://www.google.com/search?q=${encodeURIComponent(`${stockName} stock price ${currentEditingDate}`)}`, '_blank');
        }
        function updateSimpleData(type, index, key, val) { if(key === 'val') val = Number(val) || 0; currentEditingData[type][index][key] = val; updateEditTotals(); }
        function updateStockData(index, key, val) { let item = currentEditingData.invest[index]; if(key === 'name') item.name = val; else { item[key] = Number(val) || 0; item.val = Math.round(item.price * item.shares * item.exrate); } renderAssetsInput(); }
        function addRow(type) { if(type === 'invest') currentEditingData[type].push({name: "", val: 0, price: 0, shares: 0, exrate: 1}); else currentEditingData[type].push({name: "", val: 0}); renderAssetsInput(); }
        function delRow(type, index) { if(confirm("åˆªé™¤ï¼Ÿ")) { currentEditingData[type].splice(index, 1); renderAssetsInput(); } }
        function updateEditTotals() { ['cash', 'invest', 'prop', 'debt'].forEach(type => { let sum = currentEditingData[type].reduce((a, b) => a + b.val, 0); document.getElementById('total-' + type + '-edit').innerText = '$' + sum.toLocaleString(); }); }
        function getSum(arr) { return arr ? arr.reduce((a, b) => a + b.val, 0) : 0; }
        
        // åˆ‡æ›é é¢
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            if(page==='home') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(page==='input') document.querySelectorAll('.nav-item')[1].classList.add('active');
            if(page==='trend') { 
                document.querySelectorAll('.nav-item')[2].classList.add('active');
                renderCharts(); // ç¢ºä¿åˆ‡æ›åˆ°åˆ†æé æ™‚é‡ç¹ªåœ–è¡¨
                initComparison();
            }
        }

        // é¦–é è³‡æ–™è®€å–
        function loadHomeDataByDate(date) {
            let data = dataStore[date];
            if (!data) {
                document.getElementById('dash-net-worth').innerText = "ç„¡è³‡æ–™";
                document.getElementById('dash-diff').innerText = "è«‹é¸æ“‡å…¶ä»–æœˆä»½æˆ–å»è¨˜å¸³";
                document.getElementById('analysis-container').innerHTML = "<div style='text-align:center;color:#999;padding:10px;'>ğŸ“­ æœ¬æœˆå°šæœªè¨˜å¸³</div>";
                document.getElementById('cards-container').innerHTML = "";
                return;
            }
            let netWorth = (getSum(data.cash) + getSum(data.invest) + getSum(data.prop)) - getSum(data.debt);
            document.getElementById('dash-net-worth').innerText = 'NT$ ' + netWorth.toLocaleString();
            
            let dates = Object.keys(dataStore).sort();
            let currIdx = dates.indexOf(date);
            let diff = 0;
            if (currIdx > 0) {
                let prevD = dataStore[dates[currIdx - 1]];
                let prevNet = (getSum(prevD.cash) + getSum(prevD.invest) + getSum(prevD.prop)) - getSum(prevD.debt);
                diff = netWorth - prevNet;
                let sign = diff >= 0 ? 'â–²' : 'â–¼';
                let color = diff >= 0 ? 'var(--accent-color)' : 'var(--danger-color)';
                document.getElementById('dash-diff').innerText = `${sign} è¼ƒä¸Šæœˆ ${diff >= 0 ? '+' : ''}${diff.toLocaleString()}`;
                document.getElementById('dash-diff').style.color = color;
            } else { document.getElementById('dash-diff').innerText = "åˆå§‹ç´€éŒ„"; }

            // è‡ªå‹•åˆ†æ
            let diffCash = 0, diffInvest = 0, diffDebt = 0;
            if (currIdx > 0) {
                let prevData = dataStore[dates[currIdx - 1]];
                diffCash = getSum(data.cash) - getSum(prevData.cash);
                diffInvest = getSum(data.invest) - getSum(prevData.invest);
                diffDebt = getSum(data.debt) - getSum(prevData.debt);
            }
            
            document.getElementById('analysis-container').innerHTML = `
                <div class="analysis-row"><span class="analysis-label">ğŸ’° ç¾é‡‘è®Šå‹•</span><span class="analysis-val" style="color:${diffCash>=0?'var(--accent-color)':'var(--danger-color)'}">${diffCash>=0?'+':''}${diffCash.toLocaleString()}</span></div>
                <div class="analysis-row"><span class="analysis-label">ğŸ“ˆ æŠ•è³‡æç›Š</span><span class="analysis-val" style="color:${diffInvest>=0?'var(--accent-color)':'var(--danger-color)'}">${diffInvest>=0?'+':''}${diffInvest.toLocaleString()}</span></div>
                <div class="analysis-row"><span class="analysis-label">ğŸ’¸ è² å‚µè®Šå‹•</span><span class="analysis-val" style="color:${diffDebt>0?'var(--danger-color)':'var(--accent-color)'}">${diffDebt>=0?'+':''}${diffDebt.toLocaleString()}</span></div>
            `;

            const container = document.getElementById('cards-container');
            container.innerHTML = `
                ${createCard('ğŸ’° ç¾é‡‘è³‡ç”¢', getSum(data.cash), data.cash, false)}
                ${createCard('ğŸ“ˆ æŠ•è³‡éƒ¨ä½', getSum(data.invest), data.invest, false)}
                ${createCard('ğŸ  ä¸å‹•ç”¢', getSum(data.prop), data.prop, false)}
                ${createCard('ğŸ’¸ è² å‚µç¸½é¡', getSum(data.debt), data.debt, true)}
            `;
            toggleDetails();
        }
        function createCard(title, total, items, isRed) {
            let color = isRed ? 'color:var(--danger-color);' : '';
            let list = items.map(i => `<div class="detail-item"><span>${i.name||'--'}</span><span>$${i.val.toLocaleString()}</span></div>`).join('');
            return `<div class="card card-category"><div style="display:flex; justify-content:space-between; font-weight:bold;"><span>${title}</span><span style="${color}">$${total.toLocaleString()}</span></div><div class="detail-list">${list}</div></div>`;
        }
        function setMode(show) { document.getElementById('detailToggle').checked = show; toggleDetails(); }
        function toggleDetails() { let show = document.getElementById('detailToggle').checked; document.querySelectorAll('.card-category').forEach(c => show ? c.classList.add('show-details') : c.classList.remove('show-details')); }
        function exportHistoryExcel() { /* åŒV19, çœç•¥é‡è¤‡ */ alert("è«‹ä½¿ç”¨å‚™ä»½åŠŸèƒ½ç¢ºä¿è³‡æ–™å®‰å…¨"); }
        function exportData() { let dataStr = JSON.stringify(dataStore); let blob = new Blob([dataStr], {type: "application/json"}); let url = URL.createObjectURL(blob); let a = document.createElement('a'); a.href = url; a.download = "money_backup_" + getTodayStr() + ".json"; a.click(); }
        function importData(input) { let file = input.files[0]; if(!file) return; let reader = new FileReader(); reader.onload = function(e) { try { if(confirm("ç¢ºå®šåŒ¯å…¥ï¼Ÿ")) { dataStore = JSON.parse(e.target.result); localStorage.setItem('myAssetData_v9_db', JSON.stringify(dataStore)); alert("åŒ¯å…¥æˆåŠŸï¼"); location.reload(); } } catch(err) { alert("æ ¼å¼éŒ¯èª¤"); } }; reader.readAsText(file); }
    </script>
</body>
</html>
